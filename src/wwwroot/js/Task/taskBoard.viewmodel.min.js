(function(n){"use strict";(function(n){var t=15;n.ViewModel=function(){this.showDialog=new ko.observable(!1);this.dialogTitle=new ko.observable("");this.showNewButtonInDialog=new ko.observable(!1);this.dialogSearchCallback=null;this.dialogCreateNewCallback=null;this.dialogSearchPattern=new ko.observable("");this.dialogIsLoading=new ko.observable(!1);this.dialogEntries=new ko.observableArray;this.dialogHasMore=new ko.observable(!1);this.dialogCurrentPage=new ko.observable(0);this.errorOccured=new ko.observable(!1);this.idObservable=null;this.choosingDeferred=null};n.ViewModel.prototype={openNpcSearch:function(n,t){return this.openDialog(n,this.searchNpcs,t,null)},openItemSearch:function(n,t){return this.openDialog(n,this.searchItems,t,null)},openSkillSearch:function(n,t){return this.openDialog(n,this.searchSkills,t,null)},openKirjaPageSearch:function(n,t,i){return this.openDialog(n,this.searchPages,t,i)},openQuestSearch:function(n,t){return this.openDialog(n,this.searchQuest,t,null)},openChapterDetailSearch:function(n,t,i){return this.openDialog(n,this.searchChapterDetails,t,i)},openDialog:function(n,t,i,r){return this.choosingDeferred&&(this.choosingDeferred.reject(),this.choosingDeferred=null),this.showDialog(!0),this.dialogTitle(n),this.dialogCreateNewCallback=typeof i=="function"?i:null,this.showNewButtonInDialog(this.dialogCreateNewCallback?!0:!1),this.dialogSearchCallback=t,this.dialogSearchPattern(""),this.dialogIsLoading(!1),this.dialogEntries([]),this.dialogHasMore(!1),this.dialogCurrentPage(0),this.idObservable=r,this.choosingDeferred=new jQuery.Deferred,this.choosingDeferred.promise()},selectObject:function(n){this.choosingDeferred&&(this.choosingDeferred.resolve(n),this.choosingDeferred=null);this.closeDialog()},cancelDialog:function(){this.choosingDeferred&&(this.choosingDeferred.reject(),this.choosingDeferred=null);this.closeDialog()},closeDialog:function(){this.showDialog(!1)},startNewDialogSearch:function(){this.dialogCurrentPage(0);this.dialogHasMore(!1);this.runDialogSearch()},prevDialogPage:function(){this.dialogCurrentPage(this.dialogCurrentPage()-1);this.runDialogSearch()},nextDialogPage:function(){this.dialogCurrentPage(this.dialogCurrentPage()+1);this.runDialogSearch()},runDialogSearch:function(){this.dialogIsLoading(!0);this.errorOccured(!1);var n=this;this.dialogSearchCallback(this.dialogSearchPattern()).done(function(t){n.dialogHasMore(t.hasMore);n.dialogEntries(t.entries);n.dialogIsLoading(!1)}).fail(function(){n.errorOccured(!0);n.dialogIsLoading(!1)})},createDialogObject:function(n,t,i){return{id:n,name:t,openLink:i}},searchPages:function(n){var i=new jQuery.Deferred,r="/api/KirjaApi/SearchPages?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,u;return this.idObservable&&(r+="&excludeId="+this.idObservable()),u=this,jQuery.ajax({url:r,type:"GET"}).done(function(n){for(var r={hasMore:n.hasMore,entries:[]},t=0;t<n.pages.length;++t)r.entries.push(u.createDialogObject(n.pages[t].id,n.pages[t].name,"/Kirja?id="+n.pages[t].id));i.resolve(r)}).fail(function(){i.reject()}),i.promise()},openCreatePage:function(){this.dialogCreateNewCallback()},searchNpcs:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/KortistoApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Kortisto/Npc?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchItems:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/StyrApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Styr/Item?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchSkills:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/EvneApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Evne/Skill?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchQuest:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/AikaApi/GetQuests?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.quests.length;++t)u.entries.push(r.createDialogObject(n.quests[t].id,n.quests[t].name,"/Aika/Quest?id="+n.quests[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchChapterDetails:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/AikaApi/GetChapterDetails?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.details.length;++t)r.idObservable&&r.idObservable()==n.details[t].id||u.entries.push(r.createDialogObject(n.details[t].id,n.details[t].name,"/Aika/Detail?id="+n.details[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()}}})(n.ChooseObjectDialog=n.ChooseObjectDialog||{})})(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(){if(typeof ko!="undefined"){function n(n,t,i){for(var u=null,f=null,r=0;r<t.length;++r){if(t[r].id==i){u=t[r].color;break}t[r].isDefault&&(f=t[r].color)}(!f&&t.length>0&&(f=t[t.length-1].color),u||(u=f),u)&&jQuery(n).css("border-color",u)}ko.bindingHandlers.taskTypeColorBinding={init:function(t,i,r){var u=r.get("taskTypes"),f=ko.utils.unwrapObservable(i());ko.isObservable(u)&&u.subscribe(function(){n(t,ko.utils.unwrapObservable(u),f)});n(t,ko.utils.unwrapObservable(u),f)},update:function(t,i,r){var u=r.get("taskTypes"),f=ko.utils.unwrapObservable(i());n(t,ko.utils.unwrapObservable(u),f)}}}})(n.BindingHandlers=n.BindingHandlers||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(n){n.Task=function(n){this.id=n.id;this.taskNumber=0;this.taskTypeId=new ko.observable(null);this.name=new ko.observable("");this.description=new ko.observable("");this.assignedTo=new ko.observable("");this.status=new ko.observable(0);this.parseTaskFromServerResponse(n)};n.Task.prototype={parseTaskFromServerResponse:function(n){this.taskNumber=n.taskNumber;this.taskTypeId(n.taskTypeId);this.name(n.name);this.description(n.description);this.assignedTo(n.assignedTo);this.status(n.status)}}})(n.TaskBoard=n.TaskBoard||{})})(n.Task=n.Task||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(n){n.StatusColumnTaskContainer=function(n){this.status=n;this.tasks=new ko.observableArray;this.isHovering=new ko.observable(!1)};n.StatusColumnTaskContainer.prototype={activateTaskHovering:function(){this.isHovering(!0)},disableTaskHovering:function(){this.isHovering(!1)}}})(n.TaskBoard=n.TaskBoard||{})})(n.Task=n.Task||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(n){n.TaskGroup=function(t,i,r){var u,e,f;for(n.Task.apply(this,[i]),this.viewModel=t,this.isExpanded=new ko.observable(!0),this.isExpanded.subscribe(function(){r()}),this.resizeColumnFunc=r,this.statusColumns=[],this.statusColumnLookup={},u=0;u<t.taskStatus.length;++u)e=t.taskStatus[u].value,f=new n.StatusColumnTaskContainer(e),f.tasks.subscribe(function(){r()}),this.statusColumns.push(f),this.statusColumnLookup[e]=f;this.parseFromServerResponse(i)};n.TaskGroup.prototype=jQuery.extend({},n.Task.prototype);n.TaskGroup.prototype.parseFromServerResponse=function(t){n.Task.prototype.parseTaskFromServerResponse.apply(this,[t]);this.isExpanded(t.status!=this.viewModel.taskStatus[this.viewModel.taskStatus.length-1].value);this.clearColumns();t.tasks&&this.parseTasks(t.tasks)};n.TaskGroup.prototype.parseTasks=function(t){for(var r,i=0;i<t.length;++i)r=new n.Task(t[i]),this.addTask(r)};n.TaskGroup.prototype.addTask=function(n){var t=this.statusColumnLookup[n.status()];t||(t=this.statusColumns[0]);t.tasks.push(n)};n.TaskGroup.prototype.moveTaskToCorrectStatusColumn=function(n,t){var i=this.statusColumnLookup[t];i&&i.tasks.remove(n);this.addTask(n)};n.TaskGroup.prototype.removeTask=function(n){var t=this.statusColumnLookup[n.status()];t&&t.tasks.remove(n)};n.TaskGroup.prototype.clearColumns=function(){for(var n=0;n<this.statusColumns.length;++n)this.statusColumns[n].tasks([])};n.TaskGroup.prototype.toogleExpanded=function(){this.isExpanded(!this.isExpanded())}})(n.TaskBoard=n.TaskBoard||{})})(n.Task=n.Task||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){var r=9;i.ViewModel=function(i){var e,f,u,o;this.initialTaskGroupToOpenId=n.Util.getParameterFromUrl("taskGroupId");this.initialTaskToOpenId=n.Util.getParameterFromUrl("taskId");this.id=new ko.observable("");e=n.Util.getParameterFromUrl("id");e&&this.setId(e);this.taskStatus=i;f=Math.floor(r/i.length);this.taskColumnClass="col-sm-"+f+" col-md-"+f+" col-lg-"+f;this.isLoading=new ko.observable(!1);this.disableSortables=new ko.pureComputed(function(){return!this.isLoading()},this);this.isReadonly=new ko.observable(!1);this.errorOccured=new ko.observable(!1);this.additionalErrorDetails=new ko.observable("");this.taskGroupTypes=new ko.observableArray;this.taskTypes=new ko.observableArray;this.allBoardCategories=new ko.observableArray;this.allBoards=new ko.observableArray;this.allBoardsWithoutCurrent=new ko.pureComputed(function(){for(var r=this.id(),t=this.allBoards(),i=[],n=0;n<t.length;++n)t[n].id!=r&&i.push(t[n]);return i},this);this.groupedBoards=new ko.observableArray;this.allUsers=new ko.observableArray;this.boardName=new ko.observable(t.TaskBoard.Localization.Tasks);this.currentBoardDates=new ko.observable("");this.taskGroups=new ko.observableArray;u=this;this.taskGroups.subscribe(function(){u.resizeColumnHeight()});this.showTaskDialog=new ko.observable(!1);this.taskDialogTitle=new ko.observable("");this.taskDialogEditNumber=new ko.observable(null);this.taskDialogAllTaskTypes=new ko.observableArray;this.taskDialogTaskTypeId=new ko.observable("");this.taskDialogName=new ko.observable("");this.taskDialogDescription=new ko.observable("");this.taskDialogAssignedTo=new ko.observable(null);this.taskDialogStatus=new ko.observable(null);this.isTaskEditDialog=new ko.observable(!1);this.isTaskDialogReadonly=new ko.observable(!1);this.taskDialogLockedPrefix=new ko.observable("");this.taskDialogLockedByUser=new ko.observable("");this.editTaskGroup=null;this.addTaskToGroup=null;this.editTask=null;this.groupForEditTask=null;this.linkDialog=new n.ChooseObjectDialog.ViewModel;this.linkDialogInsertHtmlCallback=null;this.showDeleteDialog=new ko.observable(!1);this.deleteDialogText=new ko.observable("");this.showMoveTaskToBoardDialog=new ko.observable(!1);this.isMovingTaskToBoard=new ko.observable(!1);this.targetTaskBoardGroups=new ko.observableArray;this.isLoadingMoveTaskGroups=new ko.observable(!1);this.errorOccuredLoadingMoveTaskGroups=new ko.observable(!1);this.moveTargetTaskBoard=new ko.observable(null);this.moveTargetTaskGroup=new ko.observable(null);this.userDeferred=this.loadAllUsers();this.lastOpenedBoardIdDef=this.getLastOpenedBoardId();this.loadAllBoardCategoriesDef=this.loadAllBoardCategories();this.loadAllOpenBoards();this.loadAllTaskTypes();this.showTaskDialog.subscribe(function(n){n||(u.releaseLock(),u.setTaskDialogParameter(""))});this.id()&&(this.userDeferred.done(function(){u.loadBoard(u.id())}),this.saveLastOpenedBoardId(this.id()));o=this.id();n.Util.onUrlParameterChanged(function(){var t=n.Util.getParameterFromUrl("id");t!=o&&(o=t,u.switchBoard(t))});jQuery(window).resize(function(){u.resizeColumnHeight()})};i.ViewModel.prototype={resetErrorState:function(){this.errorOccured(!1);this.additionalErrorDetails("")},resizeColumnBackgroundColor:n.Util.debounce(function(){if(n.Util.isBootstrapXs()){jQuery(".gn-taskGroupBackgroundColor").hide();return}jQuery(".gn-taskGroupBackgroundColor").show();jQuery(".gn-taskGroupRow").each(function(){var n=jQuery(this).outerHeight()+"px";jQuery(this).find(".gn-taskGroupBackgroundColor").css("height",n)})},5),resizeColumnHeight:n.Util.debounce(function(){if(n.Util.isBootstrapXs()){jQuery(".gn-taskGroupColumnTaskContainer").each(function(){jQuery(this).css("min-height","85px")});jQuery(".gn-taskGroupTaskSortable").each(function(){jQuery(this).css("min-height","85px")});this.resizeColumnBackgroundColor();return}jQuery(".gn-taskGroupColumnTaskContainer").each(function(){jQuery(this).css("min-height","auto")});jQuery(".gn-taskGroupTaskSortable").each(function(){jQuery(this).css("min-height","auto")});jQuery(".gn-taskGroupRow").each(function(){var n=jQuery(this).outerHeight()+"px";jQuery(this).find(".gn-taskGroupColumnTaskContainer").css("min-height",n);jQuery(this).find(".gn-taskGroupTaskSortable").css("min-height",n)});this.resizeColumnBackgroundColor()},5),loadAllTaskTypes:function(){var n=this,t=jQuery.ajax({url:"/api/TaskApi/GetTaskGroupTypes",type:"GET"}).done(function(t){n.taskGroupTypes(t)}),i=jQuery.ajax({url:"/api/TaskApi/GetTaskTypes",type:"GET"}).done(function(t){n.taskTypes(t)});jQuery.when(t,i).fail(function(){n.errorOccured()})},loadAllBoardCategories:function(){var n=new jQuery.Deferred,t=this;return jQuery.ajax({url:"/api/TaskApi/GetTaskBoardCategories",type:"GET"}).done(function(i){t.allBoardCategories(i);n.resolve()}).fail(function(){n.reject()}),n.promise()},loadAllOpenBoards:function(){this.resetErrorState();this.isLoading(!0);var n=this;jQuery.ajax({url:"/api/TaskApi/GetOpenTaskBoards?start=0&pageSize=100",type:"GET"}).done(function(t){n.allBoards(t.boards);n.isLoading(!1);n.loadAllBoardCategoriesDef.done(function(){n.groupBoards();!n.id()&&t.boards.length>0?n.lastOpenedBoardIdDef.done(function(i){n.userDeferred.done(function(){var r=i?i:t.boards[0].id;n.expandCategoryThatContainsBoard(r);n.loadBoard(r)})}):n.id()&&n.expandCategoryThatContainsBoard(n.id())})}).fail(function(){n.errorOccured(!0);n.isLoading(!1)})},loadAllUsers:function(){var n=new jQuery.Deferred,t=this;return jQuery.ajax({url:"/api/UtilApi/GetAllUsers",type:"GET"}).done(function(i){t.allUsers(i);n.resolve()}).fail(function(){t.errorOccured(!0);n.reject()}),n.promise()},groupBoards:function(){for(var e,n,r=this.allBoardCategories(),t=this.allBoards(),u=[],f={},i=0;i<r.length;++i)e={isCategory:!0,id:r[i].id,name:new ko.observable(r[i].name),isExpanded:new ko.observable(r[i].isExpandedByDefault),boards:new ko.observableArray},f[r[i].id]=e,u.push(e);for(n=0;n<t.length;++n)t[n].isCategory=!1,f[t[n].categoryId]?f[t[n].categoryId].boards.push(t[n]):u.push(t[n]);this.groupedBoards(u)},expandCategoryThatContainsBoard:function(n){for(var u,r,i=this.groupedBoards(),t=0;t<i.length;++t)if(i[t].isCategory)for(u=i[t].boards(),r=0;r<u.length;++r)if(u[r].id==n){i[t].isExpanded(!0);return}},toogleBoardCategoryExpanded:function(n){n.isExpanded(!n.isExpanded())},setId:function(t){var r=this.id()&&this.id()!=t,i;this.id(t);i="id="+t;r?n.Util.setUrlParameters(i):n.Util.replaceUrlParameters(i)},switchBoard:function(n){this.id()!=n&&(this.loadBoard(n),this.saveLastOpenedBoardId(n))},loadBoard:function(n){this.errorOccured(!1);this.isLoading(!0);this.setId(n);var t=this;jQuery.ajax({url:"/api/TaskApi/GetTaskBoard?id="+encodeURIComponent(n),method:"GET"}).done(function(n){if(!n){t.allBoards().length>0?t.loadBoard(t.allBoards()[0].id):t.errorOccured(!0);return}t.boardName(n.name);t.currentBoardDates(t.formatTaskBoardDates(n));t.isReadonly(n.isClosed);n.taskGroups?t.taskGroups(t.parseTaskGroups(n.taskGroups)):t.taskGroups([]);t.isLoading(!1);t.initialTaskGroupToOpenId&&(t.openTaskGroupById(t.initialTaskGroupToOpenId),t.initialTaskGroupToOpenId=null);t.initialTaskToOpenId&&(t.openTaskById(t.initialTaskToOpenId),t.initialTaskToOpenId=null)}).fail(function(){t.errorOccured(!0);t.isLoading(!1)})},parseTaskGroups:function(n){for(var r=[],t=0;t<n.length;++t)r.push(new i.TaskGroup(this,n[t],this.resizeColumnHeight.bind(this)));return r},formatTaskBoardDates:function(n){var i="";return n.plannedStart&&(i=moment(n.plannedStart).format("L")),n.plannedStart&&n.plannedEnd?i+=" - "+moment(n.plannedEnd).format("L"):i&&(i=t.TaskBoard.Localization.StartingFrom+" "+i),i&&(i="("+i+")"),i},getLastOpenedBoardId:function(){var n=new jQuery.Deferred;return jQuery.ajax({url:"/api/TaskApi/GetLastOpenedTaskBoard",method:"GET"}).done(function(t){n.resolve(t)}).fail(function(){n.reject()}),n.promise()},saveLastOpenedBoardId:function(t){jQuery.ajax({headers:n.Util.generateAntiForgeryHeader(),url:"/api/TaskApi/SetLastOpenedTaskBoard?boardId="+encodeURIComponent(t),method:"POST"})},openTaskGroupById:function(n){for(var i=this.taskGroups(),t=0;t<i.length;++t)if(i[t].id==n){this.openEditTaskGroupDialog(i[t]);return}},openTaskById:function(n){for(var i,r,u,t,e=this.taskGroups(),f=0;f<e.length;++f)for(i=e[f],r=0;r<i.statusColumns.length;++r)for(u=i.statusColumns[r].tasks(),t=0;t<u.length;++t)if(u[t].id==n){this.openEditTaskDialog(i,u[t]);return}},openCreateTaskGroupDialog:function(){this.taskDialogTitle(t.TaskBoard.Localization.NewTaskGroup);this.taskDialogEditNumber(null);this.taskDialogLockedPrefix(t.TaskBoard.Localization.LockedTaskGroupPrefix);this.taskDialogAllTaskTypes(this.taskGroupTypes());this.resetTaskDialogValues();this.isTaskEditDialog(!1);this.editTaskGroup=null;this.addTaskToGroup=null;this.editTask=null;this.groupForEditTask=null;this.releaseLock();this.openSharedTaskDialog()},openEditTaskGroupDialog:function(n){this.isLoading()||(this.taskDialogTitle(t.TaskBoard.Localization.EditTaskGroup),this.taskDialogEditNumber(n.taskNumber),this.taskDialogLockedPrefix(t.TaskBoard.Localization.LockedTaskGroupPrefix),this.taskDialogAllTaskTypes(this.taskGroupTypes()),this.setTaskDialogValuesFromTask(n),this.isTaskEditDialog(!0),this.editTaskGroup=n,this.addTaskToGroup=null,this.editTask=null,this.groupForEditTask=null,this.acquireLock("TaskGroup",n.id),this.setTaskDialogParameter("taskGroupId="+n.id),this.openSharedTaskDialog())},openCreateNewTaskDialog:function(n){this.taskDialogTitle(t.TaskBoard.Localization.NewTask);this.taskDialogEditNumber(null);this.taskDialogLockedPrefix(t.TaskBoard.Localization.LockedTaskPrefix);this.taskDialogAllTaskTypes(this.taskTypes());this.resetTaskDialogValues();this.isTaskEditDialog(!1);this.editTaskGroup=null;this.addTaskToGroup=n;this.editTask=null;this.groupForEditTask=null;this.releaseLock();this.openSharedTaskDialog()},openEditTaskDialog:function(n,i){this.isLoading()||(this.taskDialogTitle(t.TaskBoard.Localization.EditTask),this.taskDialogEditNumber(i.taskNumber),this.taskDialogLockedPrefix(t.TaskBoard.Localization.LockedTaskPrefix),this.taskDialogAllTaskTypes(this.taskTypes()),this.setTaskDialogValuesFromTask(i),this.isTaskEditDialog(!0),this.editTaskGroup=null,this.addTaskToGroup=null,this.editTask=i,this.groupForEditTask=n,this.acquireLock("Task",i.id),this.setTaskDialogParameter("taskId="+i.id),this.openSharedTaskDialog())},setTaskDialogParameter:function(t){var i="id="+this.id();t&&(i+="&"+t);n.Util.replaceUrlParameters(i)},getDefaultTaskTypeIdFromDialogTypeList:function(){for(var n=this.taskDialogAllTaskTypes(),t=0;t<n.length;++t)if(n[t].isDefault)return n[t].id;return n.length>0?n[n.length-1].id:null},resetTaskDialogValues:function(){this.taskDialogTaskTypeId(this.getDefaultTaskTypeIdFromDialogTypeList());this.taskDialogName("");this.taskDialogDescription("");this.taskDialogAssignedTo(null);this.taskDialogStatus(null)},setTaskDialogValuesFromTask:function(n){this.taskDialogTaskTypeId(n.taskTypeId()?n.taskTypeId():this.getDefaultTaskTypeIdFromDialogTypeList());this.taskDialogName(n.name());this.taskDialogDescription(n.description());this.taskDialogAssignedTo(n.assignedTo());this.taskDialogStatus(n.status())},openSharedTaskDialog:function(){this.resetErrorState();this.showTaskDialog(!0);n.Util.setupValidation("#gn-taskDialogForm")},saveTaskDialog:function(t){var u,f,r;jQuery("#gn-taskDialogForm").valid()&&(u="/api/TaskApi/CreateTaskGroup?boardId="+this.id(),this.editTaskGroup?u="/api/TaskApi/UpdateTaskGroup?boardId="+this.id()+"&groupId="+this.editTaskGroup.id:this.addTaskToGroup?u="/api/TaskApi/CreateTask?boardId="+this.id()+"&groupId="+this.addTaskToGroup.id:this.editTask&&(u="/api/TaskApi/UpdateTask?boardId="+this.id()+"&groupId="+this.groupForEditTask.id+"&taskId="+this.editTask.id),f={taskTypeId:this.taskDialogTaskTypeId(),name:this.taskDialogName(),description:this.taskDialogDescription(),assignedTo:this.taskDialogAssignedTo(),status:this.taskDialogStatus()},this.isLoading(!0),this.resetErrorState(),r=this,jQuery.ajax({url:u,headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(f),type:"POST",contentType:"application/json"}).done(function(n){var u,f,e;r.editTaskGroup?r.editTaskGroup.parseFromServerResponse(n):r.addTaskToGroup?(u=new i.Task(n),r.addTaskToGroup.addTask(u),t||(r.editTask=u,r.groupForEditTask=r.addTaskToGroup,r.addTaskToGroup=null)):r.editTask?(f=r.editTask.status(),r.editTask.parseTaskFromServerResponse(n),r.editTask.status()!=f&&r.groupForEditTask.moveTaskToCorrectStatusColumn(r.editTask,f)):(e=new i.TaskGroup(r,n,r.resizeColumnHeight.bind(r)),r.taskGroups.push(e),t||(r.editTaskGroup=e));r.isLoading(!1)}).fail(function(){r.isLoading(!1);r.errorOccured(!0)}),t&&this.closeTaskDialog())},closeTaskDialog:function(){this.resetErrorState();this.showTaskDialog(!1)},saveTaskQuickEdit:function(t,i,r,u){var f,h,e,o,s;if(!this.isLoading())return f=i,f||(f=t),h={taskTypeId:f.taskTypeId(),name:f.name(),description:f.description(),assignedTo:f.assignedTo()?f.assignedTo():null,status:f.status()},e="/api/TaskApi/UpdateTaskGroup?boardId="+this.id()+"&groupId="+t.id,i&&(e="/api/TaskApi/UpdateTask?boardId="+this.id()+"&groupId="+t.id+"&taskId="+i.id+"&targetIndex="+u,r&&r.id!=t.id&&(e+="&oldGroupId="+r.id)),o=new jQuery.Deferred,this.isLoading(!0),this.resetErrorState(),s=this,jQuery.ajax({url:e,headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(h),type:"POST",contentType:"application/json"}).done(function(){s.isLoading(!1);o.resolve()}).fail(function(){s.isLoading(!1);s.errorOccured(!0);o.reject()}),o.promise()},dropTaskToStatus:function(n,t,i,r,u){if(!this.isLoading()){var f=t.status();t.status(r);this.saveTaskQuickEdit(n,t,i,u).fail(function(){n.id!=i.id&&n.removeTask(t);t.status(f);i.moveTaskToCorrectStatusColumn(t,r)})}},generateRichTextButtons:function(){var t=this,i={};return n.Task.TaskBoard.hasKirjaRights&&(i.insertWikiLink={title:n.Task.TaskBoard.Localization.ToolbarButtonInsertKirjaLinkTitle,icon:"glyphicon-book",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openKirjaPageSearch(n.Task.TaskBoard.Localization.ToolbarButtonInsertKirjaLinkTitle).then(function(n){t.addLinkFromLinkDialog(n)})}}),n.Task.TaskBoard.hasAikaRights&&(i.insertQuestLink={title:n.Task.TaskBoard.Localization.ToolbarButtonInsertAikaQuestLinkTitle,icon:"glyphicon-king",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openQuestSearch(n.Task.TaskBoard.Localization.ToolbarButtonInsertAikaQuestLinkTitle).then(function(n){t.addLinkFromLinkDialog(n)})}}),n.Task.TaskBoard.hasKortistoRights&&(i.insertNpcLink={title:n.Task.TaskBoard.Localization.ToolbarButtonInsertKortistoNpcLinkTitle,icon:"glyphicon-user",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openNpcSearch(n.Task.TaskBoard.Localization.ToolbarButtonInsertKortistoNpcLinkTitle).then(function(n){t.addLinkFromLinkDialog(n)})}}),n.Task.TaskBoard.hasStyrRights&&(i.insertItemLink={title:n.Task.TaskBoard.Localization.ToolbarButtonInsertStyrItemLinkTitle,icon:"glyphicon-apple",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openItemSearch(n.Task.TaskBoard.Localization.ToolbarButtonInsertStyrItemLinkTitle).then(function(n){t.addLinkFromLinkDialog(n)})}}),i},addLinkFromLinkDialog:function(n){this.linkDialogInsertHtmlCallback("<a href='"+n.openLink+"' target='_blank'>"+n.name+"<\/a>")},imageUploaded:function(n){return"/api/TaskApi/TaskImage?imageFile="+encodeURIComponent(n)},uploadError:function(n,t){this.errorOccured(!0);t&&t.responseText?this.additionalErrorDetails(t.responseText):this.additionalErrorDetails(n)},checkDescriptionOpenLink:function(n,t){return t.ctrlKey&&jQuery(t.target).is("a")?(window.open(jQuery(t.target).prop("href")),!1):!0},openDeleteDialog:function(){this.showDeleteDialog(!0);this.editTaskGroup?this.deleteDialogText(t.TaskBoard.Localization.AreYouSureYouWantToDeleteTheTaskGroup):this.deleteDialogText(t.TaskBoard.Localization.AreYouSureYouWantToDeleteTheTask)},deleteTask:function(){var i="",t;(this.editTaskGroup?i="/api/TaskApi/DeleteTaskGroup?boardId="+this.id()+"&groupId="+this.editTaskGroup.id:this.editTask&&(i="/api/TaskApi/DeleteTask?boardId="+this.id()+"&groupId="+this.groupForEditTask.id+"&taskId="+this.editTask.id),i)&&(this.closeDeleteDialog(),this.closeTaskDialog(),this.isLoading(!0),this.resetErrorState(),t=this,jQuery.ajax({url:i,headers:n.Util.generateAntiForgeryHeader(),type:"DELETE"}).done(function(){t.editTaskGroup?t.taskGroups.remove(t.editTaskGroup):t.groupForEditTask.removeTask(t.editTask);t.isLoading(!1)}).fail(function(n){t.isLoading(!1);t.errorOccured(!0);n.status==400&&n.responseText&&t.additionalErrorDetails(n.responseText)}))},closeDeleteDialog:function(){this.showDeleteDialog(!1)},openMoveTaskToBoardDialog:function(){this.showMoveTaskToBoardDialog(!0);this.isMovingTaskToBoard(this.editTaskGroup==null);this.moveTargetTaskBoard(null);this.moveTargetTaskGroup(null);this.targetTaskBoardGroups.removeAll()},loadTargetTaskBoardGroups:function(){if(!this.editTaskGroup&&(this.targetTaskBoardGroups.removeAll(),this.moveTargetTaskBoard())){this.isLoadingMoveTaskGroups(!0);this.errorOccuredLoadingMoveTaskGroups(!1);var n=this;jQuery.ajax({url:"/api/TaskApi/GetTaskBoard?id="+encodeURIComponent(this.moveTargetTaskBoard()),method:"GET"}).done(function(t){t.taskGroups&&n.targetTaskBoardGroups(t.taskGroups);n.isLoadingMoveTaskGroups(!1)}).fail(function(){n.isLoadingMoveTaskGroups(!1);n.errorOccuredLoadingMoveTaskGroups(!0)})}},formatGroupNameForMove:function(n){for(var i=n.name,t=0;t<this.taskStatus.length;++t)if(this.taskStatus[t].value==n.status){i+=" ("+this.taskStatus[t].displayName+")";break}return i},moveTaskToBoard:function(){var i,t;this.moveTargetTaskBoard()&&(this.moveTargetTaskGroup()||!this.isMovingTaskToBoard())&&(i="",this.editTaskGroup?i="/api/TaskApi/MoveTaskGroupToBoard?sourceBoardId="+this.id()+"&groupId="+this.editTaskGroup.id+"&targetBoardId="+this.moveTargetTaskBoard():this.editTask&&(i="/api/TaskApi/MoveTaskToBoard?sourceBoardId="+this.id()+"&sourceGroupId="+this.groupForEditTask.id+"&taskId="+this.editTask.id+"&targetBoardId="+this.moveTargetTaskBoard()+"&targetGroupId="+this.moveTargetTaskGroup()),i)&&(this.closeMoveTaskToBoardDialog(),this.closeTaskDialog(),this.isLoading(!0),this.resetErrorState(),t=this,jQuery.ajax({url:i,headers:n.Util.generateAntiForgeryHeader(),type:"POST"}).done(function(){t.editTaskGroup?t.taskGroups.remove(t.editTaskGroup):t.groupForEditTask.removeTask(t.editTask);t.isLoading(!1)}).fail(function(){t.isLoading(!1);t.errorOccured(!0)}))},closeMoveTaskToBoardDialog:function(){this.showMoveTaskToBoardDialog(!1)},reorderTaskGroup:function(t){this.isLoading(!0);this.resetErrorState();var i=this;jQuery.ajax({url:"/api/TaskApi/ReorderTaskGroup?boardId="+this.id()+"&groupId="+t.item.id+"&targetIndex="+t.targetIndex,headers:n.Util.generateAntiForgeryHeader(),type:"POST",contentType:"application/json"}).done(function(){i.isLoading(!1)}).fail(function(){i.isLoading(!1);i.errorOccured(!0)})},releaseLock:function(){this.isTaskDialogReadonly(!1);this.taskDialogLockedByUser("");n.LockService.releaseCurrentLock()},acquireLock:function(t,i){if(this.releaseLock(),!this.isReadonly()){var r=this;n.LockService.acquireLock(t,i).done(function(n,t){n&&(r.isTaskDialogReadonly(!0),r.taskDialogLockedByUser(t))}).fail(function(){r.errorOccured(!0)})}}}})(t.TaskBoard=t.TaskBoard||{})})(n.Task=n.Task||{})}(window.GoNorth=window.GoNorth||{});