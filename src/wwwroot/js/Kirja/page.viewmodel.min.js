(function(n){"use strict";(function(n){var t=15;n.ViewModel=function(){this.showDialog=new ko.observable(!1);this.dialogTitle=new ko.observable("");this.showNewButtonInDialog=new ko.observable(!1);this.dialogSearchCallback=null;this.dialogCreateNewCallback=null;this.dialogSearchPattern=new ko.observable("");this.dialogIsLoading=new ko.observable(!1);this.dialogEntries=new ko.observableArray;this.dialogHasMore=new ko.observable(!1);this.dialogCurrentPage=new ko.observable(0);this.errorOccured=new ko.observable(!1);this.idObservable=null;this.choosingDeferred=null};n.ViewModel.prototype={openNpcSearch:function(n,t){return this.openDialog(n,this.searchNpcs,t,null)},openItemSearch:function(n,t){return this.openDialog(n,this.searchItems,t,null)},openSkillSearch:function(n,t){return this.openDialog(n,this.searchSkills,t,null)},openKirjaPageSearch:function(n,t,i){return this.openDialog(n,this.searchPages,t,i)},openQuestSearch:function(n,t){return this.openDialog(n,this.searchQuest,t,null)},openChapterDetailSearch:function(n,t,i){return this.openDialog(n,this.searchChapterDetails,t,i)},openDialog:function(n,t,i,r){return this.choosingDeferred&&(this.choosingDeferred.reject(),this.choosingDeferred=null),this.showDialog(!0),this.dialogTitle(n),this.dialogCreateNewCallback=typeof i=="function"?i:null,this.showNewButtonInDialog(this.dialogCreateNewCallback?!0:!1),this.dialogSearchCallback=t,this.dialogSearchPattern(""),this.dialogIsLoading(!1),this.dialogEntries([]),this.dialogHasMore(!1),this.dialogCurrentPage(0),this.idObservable=r,this.choosingDeferred=new jQuery.Deferred,this.choosingDeferred.promise()},selectObject:function(n){this.choosingDeferred&&(this.choosingDeferred.resolve(n),this.choosingDeferred=null);this.closeDialog()},cancelDialog:function(){this.choosingDeferred&&(this.choosingDeferred.reject(),this.choosingDeferred=null);this.closeDialog()},closeDialog:function(){this.showDialog(!1)},startNewDialogSearch:function(){this.dialogCurrentPage(0);this.dialogHasMore(!1);this.runDialogSearch()},prevDialogPage:function(){this.dialogCurrentPage(this.dialogCurrentPage()-1);this.runDialogSearch()},nextDialogPage:function(){this.dialogCurrentPage(this.dialogCurrentPage()+1);this.runDialogSearch()},runDialogSearch:function(){this.dialogIsLoading(!0);this.errorOccured(!1);var n=this;this.dialogSearchCallback(this.dialogSearchPattern()).done(function(t){n.dialogHasMore(t.hasMore);n.dialogEntries(t.entries);n.dialogIsLoading(!1)}).fail(function(){n.errorOccured(!0);n.dialogIsLoading(!1)})},createDialogObject:function(n,t,i){return{id:n,name:t,openLink:i}},searchPages:function(n){var i=new jQuery.Deferred,r="/api/KirjaApi/SearchPages?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,u;return this.idObservable&&(r+="&excludeId="+this.idObservable()),u=this,jQuery.ajax({url:r,type:"GET"}).done(function(n){for(var r={hasMore:n.hasMore,entries:[]},t=0;t<n.pages.length;++t)r.entries.push(u.createDialogObject(n.pages[t].id,n.pages[t].name,"/Kirja?id="+n.pages[t].id));i.resolve(r)}).fail(function(){i.reject()}),i.promise()},openCreatePage:function(){this.dialogCreateNewCallback()},searchNpcs:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/KortistoApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Kortisto/Npc?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchItems:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/StyrApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Styr/Item?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchSkills:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/EvneApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Evne/Skill?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchQuest:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/AikaApi/GetQuests?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.quests.length;++t)u.entries.push(r.createDialogObject(n.quests[t].id,n.quests[t].name,"/Aika/Quest?id="+n.quests[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchChapterDetails:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/AikaApi/GetChapterDetails?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.details.length;++t)r.idObservable&&r.idObservable()==n.details[t].id||u.entries.push(r.createDialogObject(n.details[t].id,n.details[t].name,"/Aika/Detail?id="+n.details[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()}}})(n.ChooseObjectDialog=n.ChooseObjectDialog||{})})(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(){ko.bindingHandlers.childLinkClick={init:function(n,t,i,r,u){var f=t();jQuery(n).on("click","a",function(n){var t=jQuery(this).attr("href");u.$data?f.apply(u.$data,[t,n]):f(t,n)})},update:function(){}}})(n.Page=n.Page||{})})(n.Kirja=n.Kirja||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(t){var i=25,r=45,u=1,f="/Kirja?id=";t.ViewModel=function(){var u,i,f;this.id=new ko.observable("");u=n.Util.getParameterFromUrl("id");u&&this.id(u);this.isLoading=new ko.observable(!1);this.isReadonly=new ko.observable(!1);this.lockedByUser=new ko.observable("");this.isEditMode=new ko.observable(!1);this.isDirty=new ko.observable(!1);this.blockPageReload=!1;i=this;this.pageName=new ko.observable("");this.pageName.subscribe(function(){i.isDirty(!0)});this.originalPageContent=null;this.pageContent=new ko.observable("");this.pageContent.subscribe(function(){i.isDirty(!0)});this.displayVersionId=new ko.observable(null);this.displayVersionName=new ko.observable(null);this.displayVersionHtml=new ko.observable(null);this.displayVersionNumber=new ko.observable(null);this.compareVersionId=new ko.observable(null);this.compareVersionName=new ko.observable(null);this.compareVersionHtml=new ko.observable(null);this.compareVersionNumber=new ko.observable(null);this.pageContentTransformed=new ko.computed(function(){var n=null,t;return(n=this.displayVersionHtml()?this.displayVersionHtml():this.pageContent(),t=this.compareVersionHtml(),n=this.transformPageContent(n),t)?(t=this.transformPageContent(t),htmldiff(t,n)):n},this);this.currentPageName=new ko.computed(function(){var n=this.displayVersionName(),t=this.pageName();return n?n:t},this);this.pageModifiedOn=new ko.observable("");this.isDefault=new ko.observable(!1);this.showConfirmDirtyExitEdit=new ko.observable(!1);this.confirmDirtyExitPromise=null;this.showConfirmDeleteDialog=new ko.observable(!1);this.showVersionDialog=new ko.observable(!1);this.showVersionDialog.subscribe(function(){i.syncUrlParamters()});this.versionDialogErrorOccured=new ko.observable(!1);this.loadingVersions=new ko.observable(!1);this.currentVersionPage=new ko.observable(0);this.hasMoreVersions=new ko.observable(!1);this.versionDialogMostRecentVersion=new ko.observable(0);this.versions=new ko.observableArray;this.showConfirmRestoreDialog=new ko.observable(!1);this.confirmRestoreDialogLoading=new ko.observable(!1);this.confirmRestoreDialogErrorOccured=new ko.observable(!1);this.confirmRestoreBrokenLinks=new ko.observableArray;this.linkDialog=new n.ChooseObjectDialog.ViewModel;this.linkDialogInsertHtmlCallback=null;this.showNewWaitPageDialog=new ko.observable(!1);this.showSidebar=new ko.observable(!1);this.mentionedInPages=new ko.observableArray;this.loadingMentionedInPages=new ko.observable(!1);this.loadingMentionedInPagesError=new ko.observable(!1);this.mentionedQuests=new ko.observableArray;this.loadingMentionedQuests=new ko.observable(!1);this.loadingMentionedQuestsError=new ko.observable(!1);this.mentionedNpcs=new ko.observableArray;this.loadingMentionedNpcs=new ko.observable(!1);this.loadingMentionedNpcsError=new ko.observable(!1);this.mentionedItems=new ko.observableArray;this.loadingMentionedItems=new ko.observable(!1);this.loadingMentionedItemsError=new ko.observable(!1);this.mentionedSkills=new ko.observableArray;this.loadingMentionedSkills=new ko.observable(!1);this.loadingMentionedSkillsError=new ko.observable(!1);this.markedInMaps=new ko.observableArray;this.loadingMarkedInMaps=new ko.observable(!1);this.loadingMarkedInMapsError=new ko.observable(!1);this.errorOccured=new ko.observable(!1);this.additionalErrorDetails=new ko.observable("");this.pageNotFound=new ko.observable(!1);this.attachmentFiles=new ko.observableArray;this.showConfirmDeleteAttachmentDialog=new ko.observable(!1);this.attachmentToDelete=null;f=n.Util.getParameterFromUrl("newPage")=="1";this.id()||!f?this.loadPage():f&&(this.isEditMode(!0),setTimeout(function(){jQuery("#gn-kirjaPageName").focus()},1));var h=n.Util.getParameterFromUrl("versionDialog")=="1",s=parseInt(n.Util.getParameterFromUrl("versionPage")),e=n.Util.getParameterFromUrl("compareVersionId"),o=n.Util.getParameterFromUrl("displayVersionId");h&&!isNaN(s)&&this.openVersionDialogWithPage(s);e&&this.compareVersion(e);o&&this.showVersion(o);e===""&&o===""&&this.syncUrlParamters();this.attachmentUploadUrl=new ko.computed(function(){return"/api/KirjaApi/UploadPageAttachment?id="+this.id()},this);n.Util.setupValidation("#gn-kirjaHeaderFields");n.Util.onUrlParameterChanged(function(){i.blockPageReload||i.switchPage(n.Util.getParameterFromUrl("id"));i.blockPageReload=!1});t.scrollToHeader=function(n){jQuery("html, body").animate({scrollTop:Math.max(0,jQuery(".gn-header_"+n).offset().top-r)},250)}};t.ViewModel.prototype={resetErrorState:function(){this.errorOccured(!1);this.additionalErrorDetails("");this.pageNotFound(!1)},syncUrlParamters:function(){var t="id="+this.id();this.compareVersionId()&&(t+="&compareVersionId="+this.compareVersionId());this.displayVersionId()&&(t+="&displayVersionId="+this.displayVersionId());this.showVersionDialog()&&(t+="&versionDialog=1&versionPage="+this.currentVersionPage());this.blockPageReload=!0;n.Util.replaceUrlParameters(t);this.blockPageReload=!1},switchPage:function(n){this.isEditMode(!1);this.id(n);this.resetErrorState();this.showSidebar(!1);this.showVersionDialog(!1);this.displayVersionId(null);this.displayVersionName(null);this.displayVersionHtml(null);this.displayVersionNumber(null);this.compareVersionId(null);this.compareVersionName(null);this.compareVersionHtml(null);this.compareVersionNumber(null);this.syncUrlParamters();this.loadPage()},loadPage:function(){var t="/api/KirjaApi/Page",n;this.id()&&(t+="?id="+this.id());this.isLoading(!0);this.resetErrorState();n=this;jQuery.ajax({url:t,type:"GET"}).done(function(t){if(n.isLoading(!1),!t){n.errorOccured(!0);n.pageNotFound(!0);return}n.pageName(t.name);n.pageContent(n.fixOldLinks(t.content));n.originalPageContent=n.pageContent();n.pageModifiedOn(t.modifiedOn);n.isDefault(t.isDefault);n.id()||n.setId(t.id);n.loadMentionedInPages();n.loadMentionedQuests(t.mentionedQuests);n.loadMentionedNpcs(t.mentionedNpcs);n.loadMentionedItems(t.mentionedItems);n.loadMentionedSkills(t.mentionedSkills);n.loadMarkedInMaps();n.attachmentFiles(t.attachments?t.attachments:[]);n.isDirty(!1);n.checkLock()}).fail(function(){n.errorOccured(!0);n.isLoading(!1)})},generateRichTextButtons:function(){var t=this,i={};return i.insertTableOfContent={title:n.Kirja.Page.toolbarButtonInsertTableOfContentTitle,icon:"glyphicon-list-alt",callback:function(n){n("<br/><span contenteditable='false'><gn-kirjaTableOfContent><\/gn-kirjaTableOfContent><\/span><br/>")}},i.insertWikiLink={title:n.Kirja.Page.toolbarButtonInsertKirjaLinkTitle,icon:"glyphicon-book",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openKirjaPageSearch(n.Kirja.Page.toolbarButtonInsertKirjaLinkTitle,function(){t.openCreatePage()},t.id).then(function(n){t.addLinkFromLinkDialog(n,!0)})}},n.Kirja.Page.hasAikaRights&&(i.insertQuestLink={title:n.Kirja.Page.toolbarButtonInsertAikaQuestLinkTitle,icon:"glyphicon-king",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openQuestSearch(n.Kirja.Page.toolbarButtonInsertAikaQuestLinkTitle).then(function(n){t.addLinkFromLinkDialog(n,!1)})}}),n.Kirja.Page.hasKortistoRights&&(i.insertNpcLink={title:n.Kirja.Page.toolbarButtonInsertKortistoNpcLinkTitle,icon:"glyphicon-user",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openNpcSearch(n.Kirja.Page.toolbarButtonInsertKortistoNpcLinkTitle).then(function(n){t.addLinkFromLinkDialog(n,!1)})}}),n.Kirja.Page.hasStyrRights&&(i.insertItemLink={title:n.Kirja.Page.toolbarButtonInsertStyrItemLinkTitle,icon:"glyphicon-apple",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openItemSearch(n.Kirja.Page.toolbarButtonInsertStyrItemLinkTitle).then(function(n){t.addLinkFromLinkDialog(n,!1)})}}),n.Kirja.Page.hasEvneRights&&(i.insertSkillLink={title:n.Kirja.Page.toolbarButtonInsertEvneSkillLinkTitle,icon:"glyphicon-flash",callback:function(i){t.linkDialogInsertHtmlCallback=i;t.linkDialog.openSkillSearch(n.Kirja.Page.toolbarButtonInsertEvneSkillLinkTitle).then(function(n){t.addLinkFromLinkDialog(n,!1)})}}),i},pushKirjaPageState:function(t,i){if(i.which==u)return!t||!t.toLowerCase().indexOf("/kirja")==0?void 0:(t=t.toLowerCase().replace("/kirja?",""),n.Util.setUrlParameters(t),i.preventDefault(),!1)},fixOldLinks:function(n){return n?(n=this.fixOldLinksByControllerUrl(n,"/Kirja"),n=this.fixOldLinksByControllerUrl(n,"/Kortisto/Npc"),n=this.fixOldLinksByControllerUrl(n,"/Styr/Item"),n=this.fixOldLinksByControllerUrl(n,"/Evne/Skill"),this.fixOldLinksByControllerUrl(n,"/Aika/Quest")):""},fixOldLinksByControllerUrl:function(n,t){var i=new RegExp(' href="'+t+'#id=([0-9A-F]{8}-([0-9A-F]{4}-){3}[0-9A-F]{12})"',"gi");return n.replace(i,function(n){return n.replace("#","?")})},transformPageContent:function(n){var t=jQuery("<div>"+n+"<\/div>"),i=this.transformHeaders(t),r=this;return t.find("gn-kirjaTableOfContent").each(function(){jQuery(this).replaceWith(r.buildTableOfContent(i))}),t.html()},transformHeaders:function(n){var r=[],t=null,i=0;return n.find("h4,h5").each(function(){var n=this.outerHTML,u,f;n="<span class='gn-header_"+i+"'>"+n+"<\/span>";u=jQuery(this).text();jQuery(this).prop("tagName").toLowerCase()=="h4"?(t={name:u,id:i,subHeaders:[]},r.push(t)):(f={name:u,id:i},t?t.subHeaders.push(f):r.push(f));jQuery(this).replaceWith(n);++i}),r},buildTableOfContent:function(t){var i="<div class='gn-kirjaTableOfContentTransformed'>";return i+="<div class='gn-kirjaTableOfContentTransformedHeader'>"+n.Kirja.Page.tableOfContent+"<\/div>",i+=this.buildTableOfContentForHeaders(t),i+"<\/div>"},buildTableOfContentForHeaders:function(n){for(var i="<ul>",t=0;t<n.length;++t)i+="<li><a class='gn-clickable' onclick='GoNorth.Kirja.Page.scrollToHeader("+n[t].id+")'>"+n[t].name+"<a>",n[t].subHeaders&&n[t].subHeaders.length>0&&(i+=this.buildTableOfContentForHeaders(n[t].subHeaders));return i+"<\/ul>"},enterEditMode:function(){this.showSidebar(!1);this.isEditMode(!0);this.displayVersionId(null);this.displayVersionName(null);this.displayVersionHtml(null);this.displayVersionNumber(null);this.compareVersionId(null);this.compareVersionName(null);this.compareVersionHtml(null);this.compareVersionNumber(null);this.syncUrlParamters();this.acquireLock()},exitEditMode:function(){var n=new jQuery.Deferred;return this.confirmDirtyExitPromise=n,this.isDirty()?this.showConfirmDirtyExitEdit(!0):this.exitEditModeWithoutDirtyCheck(),n.promise()},discardChanges:function(){this.pageContent(this.originalPageContent);this.exitEditModeWithoutDirtyCheck()},exitEditModeWithoutDirtyCheck:function(){this.isEditMode(!1);this.showConfirmDirtyExitEdit(!1);n.LockService.releaseCurrentLock();this.confirmDirtyExitPromise&&(this.confirmDirtyExitPromise.resolve(),this.confirmDirtyExitPromise=null)},closeConfirmDirtyExitEdit:function(){this.confirmDirtyExitPromise&&(this.confirmDirtyExitPromise.reject(),this.confirmDirtyExitPromise=null);this.showConfirmDirtyExitEdit(!1)},imageUploaded:function(n){return"/api/KirjaApi/KirjaImage?imageFile="+encodeURIComponent(n)},attachmentUploaded:function(n){this.attachmentFiles.push(n);this.attachmentFiles.sort(function(n,t){return n.originalFilename.localeCompare(t.originalFilename)})},buildAttachmentUrl:function(n){return"/api/KirjaApi/KirjaAttachment?pageId="+this.id()+"&attachmentFile="+encodeURIComponent(n.filename)},uploadError:function(n,t){this.errorOccured(!0);t&&t.responseText?this.additionalErrorDetails(t.responseText):this.additionalErrorDetails(n)},openDeleteAttachmentDialog:function(n){this.showConfirmDeleteAttachmentDialog(!0);this.attachmentToDelete=n},deleteAttachment:function(){var i=this.attachmentToDelete,t;this.isLoading(!0);this.resetErrorState();t=this;jQuery.ajax({url:"/api/KirjaApi/DeleteAttachment?pageId="+this.id()+"&attachmentFile="+encodeURIComponent(i.filename),headers:n.Util.generateAntiForgeryHeader(),type:"DELETE"}).done(function(){t.attachmentFiles.remove(i);t.isLoading(!1)}).fail(function(){t.isLoading(!1);t.errorOccured(!0)});this.closeConfirmAttachmentDeleteDialog()},closeConfirmAttachmentDeleteDialog:function(){this.showConfirmDeleteAttachmentDialog(!1);this.attachmentToDelete=null},save:function(){var i,r,t;jQuery("#gn-kirjaHeaderFields").valid()&&(i="/api/KirjaApi/CreatePage",this.id()&&(i="/api/KirjaApi/UpdatePage?id="+this.id()),r={name:this.pageName(),content:this.pageContent()},this.isLoading(!0),this.resetErrorState(),t=this,jQuery.ajax({url:i,headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(r),type:"POST",contentType:"application/json"}).done(function(n){t.id()||(t.setId(n.id),t.acquireLock(),window.newKirjaPageSaved&&(window.newKirjaPageSaved(n.id,t.pageName()),window.newKirjaPageSaved=null));t.loadMentionedQuests(n.mentionedQuests);t.loadMentionedNpcs(n.mentionedNpcs);t.loadMentionedItems(n.mentionedItems);t.loadMentionedSkills(n.mentionedSkills);t.pageModifiedOn(n.modifiedOn);t.callPageRefreshGrid();t.isDirty(!1);t.isLoading(!1);t.originalPageContent=t.pageContent()}).fail(function(){t.isLoading(!1);t.errorOccured(!0)}))},openVersionDialog:function(){this.openVersionDialogWithPage(0)},openVersionDialogWithPage:function(n){this.id()&&(this.showSidebar(!1),this.showVersionDialog(!0),this.versions.removeAll(),this.currentVersionPage(n),this.hasMoreVersions(!1),this.loadVersionPage())},prevVersionPage:function(){this.currentVersionPage()!=0&&(this.currentVersionPage(this.currentVersionPage()-1),this.loadVersionPage())},nextVersionPage:function(){this.hasMoreVersions()&&(this.currentVersionPage(this.currentVersionPage()+1),this.loadVersionPage())},loadVersionPage:function(){var t,r,n;if(this.syncUrlParamters(),t=this.currentVersionPage()*i,r=i,this.currentVersionPage()==0?r=i-1:t=t-1,r==0){this.hasMoreVersions(!0);this.versions.removeAll();return}this.loadingVersions(!0);this.versionDialogErrorOccured(!1);n=this;jQuery.ajax({url:"/api/KirjaApi/GetPageVersions?pageId="+this.id()+"&start="+t+"&pageSize="+r,type:"GET"}).done(function(t){n.loadingVersions(!1);n.hasMoreVersions(t.hasMore);n.versionDialogMostRecentVersion(t.mostRecentVersion);n.versions(t.versions)}).fail(function(){n.loadingVersions(!1);n.versions.removeAll();n.versionDialogErrorOccured(!0)})},closeVersionDialog:function(){this.showVersionDialog(!1)},compareWithVersionObject:function(n){if(this.isEditMode()){var t=this;this.exitEditMode().done(function(){t.closeVersionDialog();t.compareVersion(n.id)})}else this.closeVersionDialog(),this.compareVersion(n.id)},compareVersion:function(n){this.isLoading(!0);this.errorOccured(!1);var t=this;this.loadPageVersion(n).done(function(n){t.isLoading(!1);var i=n.version;i&&i.id!=t.displayVersionId()?(t.compareVersionId(i.id),t.compareVersionName(i.name),t.compareVersionHtml(i.content),t.compareVersionNumber(i.versionNumber),t.syncUrlParamters()):t.exitCompareMode()}).fail(function(){t.isLoading(!1);t.errorOccured(!0)})},exitCompareMode:function(){this.compareVersionId(null);this.compareVersionName(null);this.compareVersionHtml(null);this.compareVersionNumber(null);this.syncUrlParamters()},showVersionWithObject:function(n){if(this.isEditMode()){var t=this;this.exitEditMode().done(function(){t.closeVersionDialog();t.exitCompareMode();t.showVersion(n.id)})}else this.closeVersionDialog(),this.exitCompareMode(),this.showVersion(n.id)},showVersion:function(n){this.isLoading(!0);this.errorOccured(!1);var t=this;this.loadPageVersion(n).done(function(n){t.isLoading(!1);var i=n.version;i&&i.versionNumber!=n.mostRecentVersion?(t.displayVersionId(i.id),t.displayVersionName(i.name),t.displayVersionHtml(i.content),t.displayVersionNumber(i.versionNumber),t.syncUrlParamters()):t.exitDisplayMode()}).fail(function(){t.isLoading(!1);t.errorOccured(!0)})},exitDisplayMode:function(){this.displayVersionId(null);this.displayVersionName(null);this.displayVersionHtml(null);this.displayVersionNumber(null);this.syncUrlParamters()},exitDisplayAndCompareMode:function(){this.exitDisplayMode();this.exitCompareMode()},openRestoreDialog:function(){if(this.displayVersionId()){this.showConfirmRestoreDialog(!0);this.confirmRestoreBrokenLinks.removeAll();this.confirmRestoreDialogLoading(!0);this.confirmRestoreDialogErrorOccured(!1);var t=this;jQuery.ajax({url:"/api/KirjaApi/ValidateVersionReferences?versionId="+this.displayVersionId(),type:"GET"}).done(function(i){t.confirmRestoreDialogLoading(!1);var r=jQuery("<div>"+t.displayVersionHtml()+"<\/div>");t.findMissingReferences(r,"/Kortisto/Npc",n.Kirja.Page.Npc,i.missingNpcs);t.findMissingReferences(r,"/Styr/Item",n.Kirja.Page.Item,i.missingItems);t.findMissingReferences(r,"/Evne/Skill",n.Kirja.Page.Skill,i.missingSkills);t.findMissingReferences(r,"/Aika/Quest",n.Kirja.Page.Quest,i.missingQuests);t.findMissingReferences(r,"/Kirja",n.Kirja.Page.KirjaPage,i.missingPages)}).fail(function(){t.confirmRestoreDialogLoading(!1);t.confirmRestoreDialogErrorOccured(!0)})}},findMissingReferences:function(n,t,i,r){for(var f,e=this,u=0;u<r.length;++u)f="a[href^='"+t+"?id="+r[u]+"']",n.find(f).each(function(){e.confirmRestoreBrokenLinks.push({selector:f,linkText:jQuery(this).text(),objectLabel:i})})},restoreVersion:function(){var n=this.removeMissingReferences(this.displayVersionHtml());this.pageName(this.displayVersionName());this.pageContent(n);this.closeConfirmRestoreDialog();this.exitCompareMode();this.exitDisplayMode();this.save()},removeMissingReferences:function(n){var i=this.confirmRestoreBrokenLinks(),r,t;if(i.length==0)return n;for(r=jQuery("<div>"+n+"<\/div>"),t=0;t<i.length;++t)r.find(i[t].selector).contents().unwrap();return r.html()},closeConfirmRestoreDialog:function(){this.showConfirmRestoreDialog(!1)},loadPageVersion:function(n){return jQuery.ajax({url:"/api/KirjaApi/PageVersion?versionId="+n,type:"GET"})},loadMentionedInPages:function(){if(this.id()){this.loadingMentionedInPages(!0);this.loadingMentionedInPagesError(!1);var n=this;jQuery.ajax({url:"/api/KirjaApi/GetPagesByPage?pageId="+this.id(),type:"GET"}).done(function(t){for(var r=[],i=0;i<t.length;++i)r.push({openLink:"/Kirja?id="+t[i].id,name:t[i].name});n.mentionedInPages(r);n.loadingMentionedInPages(!1)}).fail(function(){n.mentionedInPages([]);n.loadingMentionedInPages(!1);n.loadingMentionedInPagesError(!0)})}},loadMentionedQuests:function(t){if(n.Kirja.Page.hasAikaRights&&t){this.loadingMentionedQuests(!0);this.loadingMentionedQuestsError(!1);var i=this;jQuery.ajax({url:"/api/AikaApi/ResolveQuestNames",headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(t),type:"POST",contentType:"application/json"}).done(function(n){for(var r=[],t=0;t<n.length;++t)r.push({openLink:"/Aika/Quest?id="+n[t].id,name:n[t].name});i.mentionedQuests(r);i.loadingMentionedQuests(!1)}).fail(function(){i.mentionedQuests([]);i.loadingMentionedQuests(!1);i.loadingMentionedQuestsError(!0)})}},loadMentionedNpcs:function(t){if(n.Kirja.Page.hasKortistoRights&&t){this.loadingMentionedNpcs(!0);this.loadingMentionedNpcsError(!1);var i=this;jQuery.ajax({url:"/api/KortistoApi/ResolveFlexFieldObjectNames",headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(t),type:"POST",contentType:"application/json"}).done(function(n){for(var r=[],t=0;t<n.length;++t)r.push({openLink:"/Kortisto/Npc?id="+n[t].id,name:n[t].name});i.mentionedNpcs(r);i.loadingMentionedNpcs(!1)}).fail(function(){i.mentionedNpcs([]);i.loadingMentionedNpcs(!1);i.loadingMentionedNpcsError(!0)})}},loadMentionedItems:function(t){if(n.Kirja.Page.hasKortistoRights&&t){this.loadingMentionedItems(!0);this.loadingMentionedItemsError(!1);var i=this;jQuery.ajax({url:"/api/StyrApi/ResolveFlexFieldObjectNames",headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(t),type:"POST",contentType:"application/json"}).done(function(n){for(var r=[],t=0;t<n.length;++t)r.push({openLink:"/Styr/Item?id="+n[t].id,name:n[t].name});i.mentionedItems(r);i.loadingMentionedItems(!1)}).fail(function(){i.mentionedItems([]);i.loadingMentionedItems(!1);i.loadingMentionedItemsError(!0)})}},loadMentionedSkills:function(t){if(n.Kirja.Page.hasEvneRights&&t){this.loadingMentionedSkills(!0);this.loadingMentionedSkillsError(!1);var i=this;jQuery.ajax({url:"/api/EvneApi/ResolveFlexFieldObjectNames",headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(t),type:"POST",contentType:"application/json"}).done(function(n){for(var r=[],t=0;t<n.length;++t)r.push({openLink:"/Evne/Skill?id="+n[t].id,name:n[t].name});i.mentionedSkills(r);i.loadingMentionedSkills(!1)}).fail(function(){i.mentionedSkills([]);i.loadingMentionedSkills(!1);i.loadingMentionedSkillsError(!0)})}},loadMarkedInMaps:function(){if(n.Kirja.Page.hasKartaRights){this.markedInMaps([]);this.loadingMarkedInMaps(!0);this.loadingMarkedInMapsError(!1);var t=this;jQuery.ajax({url:"/api/KartaApi/GetMapsByKirjaPageId?pageId="+this.id(),type:"GET"}).done(function(i){for(var u,f=[],r=0;r<i.length;++r)u="/Karta?id="+i[r].mapId,i[r].markerIds.length==1&&(u+="&zoomOnMarkerId="+i[r].markerIds[0]+"&zoomOnMarkerType="+i[r].mapMarkerType),f.push({openLink:u,name:i[r].name,markerCount:i[r].markerIds.length,tooltip:n.Kirja.Page.kirjaMapMarkerCountTooltip.replace("{0}",i[r].markerIds.length)});t.markedInMaps(f);t.loadingMarkedInMaps(!1)}).fail(function(){t.loadingMarkedInMaps(!1);t.loadingMarkedInMapsError(!0)})}},setId:function(t){var r=!!this.id(),i;this.id(t);this.blockPageReload=!0;i="id="+t;r?n.Util.setUrlParameters(i):n.Util.replaceUrlParameters(i)},openConfirmDeleteDialog:function(){this.showConfirmDeleteDialog(!0)},closeConfirmDeleteDialog:function(){this.showConfirmDeleteDialog(!1)},deletePage:function(){this.closeConfirmDeleteDialog();this.isLoading(!0);this.resetErrorState();var t=this;jQuery.ajax({url:"/api/KirjaApi/DeletePage?id="+this.id(),headers:n.Util.generateAntiForgeryHeader(),type:"DELETE"}).done(function(){t.isLoading(!1);t.callPageRefreshGrid()?window.close():window.location="/Kirja"}).fail(function(n){t.isLoading(!1);t.errorOccured(!0);n.status==400&&n.responseText&&t.additionalErrorDetails(n.responseText)})},addLinkFromLinkDialog:function(n,t){t?this.linkDialogInsertHtmlCallback("<a href='"+n.openLink+"'>"+n.name+"<\/a>"):this.linkDialogInsertHtmlCallback("<a href='"+n.openLink+"' target='_blank'>"+n.name+"<\/a>")},openCreatePage:function(){this.linkDialog.closeDialog();this.showNewWaitPageDialog(!0);var n=this,t=window.open("/Kirja?newPage=1");t.onbeforeunload=function(){n.showNewWaitPageDialog(!1)};t.newKirjaPageSaved=function(t,i){n.addLinkFromLinkDialog({name:i,openLink:f+t,id:t},!0);n.showNewWaitPageDialog(!1);n.save()}},toogleSidebar:function(){this.showSidebar(!this.showSidebar())},checkLock:function(){var t=this;n.LockService.checkLock("KirjaPage",this.id()).done(function(n,i){t.handleLockResult(n,i)}).fail(function(){t.errorOccured(!0);t.exitEditModeWithoutDirtyCheck()})},acquireLock:function(){var t=this;n.LockService.acquireLock("KirjaPage",this.id()).done(function(n,i){t.handleLockResult(n,i)}).fail(function(){t.errorOccured(!0);t.exitEditModeWithoutDirtyCheck()})},handleLockResult:function(n,t){n?(this.isReadonly(!0),this.lockedByUser(t),this.exitEditModeWithoutDirtyCheck()):(this.isReadonly(!1),this.lockedByUser(""))},callPageRefreshGrid:function(){return window.refreshKirjaPageGrid?(window.refreshKirjaPageGrid(),!0):!1}}})(t.Page=t.Page||{})})(n.Kirja=n.Kirja||{})}(window.GoNorth=window.GoNorth||{});