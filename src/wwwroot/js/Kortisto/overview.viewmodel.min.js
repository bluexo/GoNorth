(function(n){"use strict";(function(t){(function(t){var i=48,r=6;t.BaseViewModel=function(t,i){var c=0,l=parseInt(n.Util.getParameterFromUrl("page")),f,u,e,o,s,h,r;isNaN(l)||(c=l);this.apiControllerName=t;this.objectPageUrl=i;this.availableTemplates=new ko.observableArray;this.currentFolderId=new ko.observable("");f=n.Util.getParameterFromUrl("folderId");f&&this.currentFolderId(f);this.parentFolderId=new ko.observable("");this.currentFolderName=new ko.observable("");this.currentFolderNameDisplay=new ko.computed(function(){var n=this.currentFolderName();return n?" - "+n:""},this);this.currentPage=new ko.observable(c);this.displayObjectRows=new ko.observableArray;this.hasMore=new ko.observable(!1);this.isLoading=new ko.observable(!1);this.prevLoading=new ko.observable(!1);this.nextLoading=new ko.observable(!1);u="";e=n.Util.getParameterFromUrl("searchTerm");e&&(u=e);this.searchPattern=new ko.observable(u);this.currentSearchPattern=u;this.initializeEmptyValues();o=parseInt(n.Util.getParameterFromUrl("folderPage"));isNaN(o)||(this.folderPage=o);s=parseInt(n.Util.getParameterFromUrl("objectPage"));isNaN(s)||(this.flexFieldObjectPage=s);h=parseInt(n.Util.getParameterFromUrl("objectStartPageSize"));isNaN(h)||(this.flexFieldObjectStartPageSize=h);parseInt(n.Util.getParameterFromUrl("useStartPageSize"))==1&&(this.useFlexFieldObjectStartPageSize=!0);this.showConfirmDeleteFolderDialog=new ko.observable(!1);this.deleteFolderError=new ko.observable("");this.deleteFolderId="";this.showFolderCreateEditDialog=new ko.observable(!1);this.createEditFolderName=new ko.observable;this.createEditFolderDescription=new ko.observable;this.createEditFolderError=new ko.observable;this.editFolderId=new ko.observable("");this.hasFolderImageInQueue=new ko.observable(!1);this.editFolderImageId=new ko.observable("");this.createEditFolderUrl=new ko.computed(function(){return"/api/"+this.apiControllerName+"/UploadFolderImage?id="+this.editFolderImageId()},this);this.clearFolderFiles=null;this.processFolderQueue=null;this.dialogLoading=new ko.observable(!1);this.errorOccured=new ko.observable(!1);this.prevLoading(!0);this.nextLoading(!0);this.loadPage(!0);this.loadAvailableTemplates();r=this;n.Util.onUrlParameterChanged(function(){var t=n.Util.getParameterFromUrl("folderId");t!=r.currentFolderId()&&(t?r.currentFolderId(t):r.currentFolderId(""),r.showAllLoading(),r.currentPage(0),r.initializeEmptyValues(),r.loadPage(!0))})};t.BaseViewModel.prototype={initializeEmptyValues:function(){this.folders=[];this.hasMoreFolders=!1;this.folderPage=0;this.flexFieldObjects=[];this.hasMoreFlexFieldObjects=!1;this.flexFieldObjectPage=0;this.flexFieldObjectStartPageSize=0;this.useFlexFieldObjectStartPageSize=!1},resetLoading:function(){this.isLoading(!1);this.prevLoading(!1);this.nextLoading(!1)},showAllLoading:function(){this.isLoading(!0);this.prevLoading(!0);this.nextLoading(!0)},loadAvailableTemplates:function(){var n=this;jQuery.ajax("/api/"+this.apiControllerName+"/FlexFieldTemplates?start=0&pageSize=1000").done(function(t){n.availableTemplates(t.flexFieldObjects)}).fail(function(){n.errorOccured(!0)})},savePagingInformation:function(){var n="?"+this.buildUrlParameters(!1);window.history.replaceState(n,null,n)},loadPage:function(n){var i,t;this.savePagingInformation();i=[];this.currentSearchPattern||i.push(this.loadFolders());i.push(this.loadFlexFieldObjects(n));this.errorOccured(!1);t=this;jQuery.when.apply(jQuery,i).done(function(){t.updateDisplay();t.resetLoading()}).fail(function(){t.errorOccured(!0);t.resetLoading()})},loadFolders:function(){var n=new jQuery.Deferred,r,t;return this.folderPage<this.currentPage()?(this.folders=[],n.resolve(),n.promise()):(r="?start="+this.currentPage()*i+"&pageSize="+i,this.currentFolderId()&&(r+="&parentId="+this.currentFolderId()),t=this,jQuery.ajax("/api/"+this.apiControllerName+"/Folders"+r).done(function(i){t.parentFolderId(i.parentId);t.currentFolderName(i.folderName);t.folders=i.folders;t.hasMoreFolders=i.hasMore;n.resolve()}).fail(function(){n.reject()}),n.promise())},loadFlexFieldObjects:function(n){var t=new jQuery.Deferred,r,u,f,e;return!n&&this.hasMoreFolders?(t.resolve(),t.promise()):(r=this.flexFieldObjectPage*i,this.useFlexFieldObjectStartPageSize&&(r+=this.flexFieldObjectStartPageSize),u="?start="+r+"&pageSize="+i,this.currentFolderId()&&(u+="&parentId="+this.currentFolderId()),f="/api/"+this.apiControllerName+"/FlexFieldObjects"+u,this.currentSearchPattern&&(f="/api/"+this.apiControllerName+"/SearchFlexFieldObjects?searchPattern="+this.currentSearchPattern+"&start="+this.currentPage()+"&pageSize="+i),e=this,jQuery.ajax(f).done(function(n){e.flexFieldObjects=n.flexFieldObjects;e.hasMoreFlexFieldObjects=n.hasMore;t.resolve()}).fail(function(){t.reject()}),t.promise())},searchFlexFieldObjects:function(){this.currentSearchPattern=this.searchPattern();this.currentPage(0);this.initializeEmptyValues();this.showAllLoading();this.loadPage()},updateDisplay:function(){var f=this,t=[],n=[],u;t.push(n);jQuery.each(this.folders,function(i,u){n.push({template:"gn-folderTemplate",id:u.id,parentId:u.parentFolderId,name:u.name,description:u.description,imageFile:u.imageFile,thumbnailImage:u.thumbnailImageFile?u.thumbnailImageFile:u.imageFile,tileUrl:window.location.pathname+"?folderId="+u.id,isFolder:!0});n.length>=r&&(n=[],t.push(n))});u=!1;!this.hasMoreFolders&&this.folders.length<i&&(jQuery.each(this.flexFieldObjects,function(e,o){if(e+f.folders.length>=i)return u=!0,!1;n.push({template:"gn-flexFieldObjectTemplate",id:o.id,parentId:o.parentFolderId,name:o.name,imageFile:o.imageFile,thumbnailImage:o.thumbnailImageFile?o.thumbnailImageFile:o.imageFile,tileUrl:f.objectPageUrl+"?id="+o.id,isFolder:!1});n.length>=r&&(n=[],t.push(n))}),this.folders.length>0&&(this.flexFieldObjectStartPageSize=i-this.folders.length));this.hasMore(this.hasMoreFolders||this.hasMoreFlexFieldObjects||this.folders.length>=i&&this.flexFieldObjects.length>0||u);this.displayObjectRows(t)},prevPage:function(){this.currentPage(this.currentPage()-1);this.folderPage>this.currentPage()?(this.folderPage=this.currentPage(),this.flexFieldObjectPage=0):this.calcFlexFieldObjectPage();this.prevLoading(!0);this.loadPage()},nextPage:function(){this.currentPage(this.currentPage()+1);this.hasMoreFolders?this.folderPage=this.currentPage():this.calcFlexFieldObjectPage();this.nextLoading(!0);this.loadPage()},calcFlexFieldObjectPage:function(){this.flexFieldObjectPage=this.currentPage()-this.folderPage-1;this.flexFieldObjectPage<0?(this.flexFieldObjectPage=0,this.useFlexFieldObjectStartPageSize=!1):this.useFlexFieldObjectStartPageSize=!0},buildUrlParameters:function(n){var t="";return!n&&this.currentFolderId()?t="folderId="+this.currentFolderId()+"&":n&&this.parentFolderId()&&(t="folderId="+this.parentFolderId()+"&"),t+="page="+this.currentPage()+"&folderPage="+this.folderPage+"&objectPage="+this.flexFieldObjectPage+"&objectStartPageSize="+this.flexFieldObjectStartPageSize+"&useStartPageSize="+(this.useFlexFieldObjectStartPageSize?1:0),this.currentSearchPattern&&(t+="&searchTerm="+encodeURIComponent(this.currentSearchPattern)),t},navigateLevelBack:function(){n.Util.setUrlParameters(this.buildUrlParameters(!0))},openCreateFolderDialog:function(){this.showFolderCreateEditDialog(!0);this.createEditFolderName("");this.createEditFolderDescription("");this.resetSharedCreateEditDialog();this.editFolderId("")},openEditFolderDialog:function(n){this.showFolderCreateEditDialog(!0);this.createEditFolderName(n.name);this.createEditFolderDescription(n.description?n.description:"");this.resetSharedCreateEditDialog();this.editFolderId(n.id)},resetSharedCreateEditDialog:function(){this.editFolderImageId("");this.createEditFolderError("");this.clearFolderFiles();this.hasFolderImageInQueue(!1);this.dialogLoading(!1);n.Util.setupValidation("#gn-folderCreateEditForm")},closeCreateEditFolderDialog:function(){this.showFolderCreateEditDialog(!1);this.dialogLoading(!1)},receiveDropzoneTriggers:function(n,t){this.clearFolderFiles=n;this.processFolderQueue=t},folderImageAdded:function(){this.hasFolderImageInQueue(!0)},saveFolder:function(){var r,i,t;jQuery("#gn-folderCreateEditForm").valid()&&(r={name:this.createEditFolderName(),description:this.createEditFolderDescription(),parentId:this.currentFolderId()},i="/api/"+this.apiControllerName+"/CreateFolder",this.editFolderId()&&(i="/api/"+this.apiControllerName+"/UpdateFolder?id="+this.editFolderId()),t=this,this.dialogLoading(!0),jQuery.ajax({url:i,headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(r),type:"POST",contentType:"application/json"}).done(function(n){t.hasFolderImageInQueue()?(t.editFolderImageId(n),t.processFolderQueue()):t.folderSuccess()}).fail(function(n){t.folderError(n)}))},folderSuccess:function(){this.closeCreateEditFolderDialog();this.loadPage()},folderError:function(n){this.dialogLoading(!1);this.createEditFolderError(n.responseJSON)},openDeleteFolderDialog:function(n){this.showConfirmDeleteFolderDialog(!0);this.deleteFolderError("");this.dialogLoading(!1);this.deleteFolderId=n.id},closeConfirmDeleteFolderDialog:function(){this.showConfirmDeleteFolderDialog(!1);this.dialogLoading(!1);this.deleteFolderId=""},deleteFolder:function(){var t=this;this.dialogLoading(!0);jQuery.ajax({url:"/api/"+this.apiControllerName+"/DeleteFolder?id="+this.deleteFolderId,headers:n.Util.generateAntiForgeryHeader(),type:"DELETE"}).done(function(){t.closeConfirmDeleteFolderDialog();t.loadPage()}).fail(function(n){t.dialogLoading(!1);t.deleteFolderError(n.responseText)})},openNewFlexFieldObjectForm:function(n){window.location=this.objectPageUrl+"?templateId="+n.id+"&folderId="+this.currentFolderId()}}})(t.Overview=t.Overview||{})})(n.FlexFieldDatabase=n.FlexFieldDatabase||{})})(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(t){t.ViewModel=function(){n.FlexFieldDatabase.Overview.BaseViewModel.apply(this,["KortistoApi","/Kortisto/Npc"])};t.ViewModel.prototype=jQuery.extend({},n.FlexFieldDatabase.Overview.BaseViewModel.prototype)})(t.Overview=t.Overview||{})})(n.Kortisto=n.Kortisto||{})}(window.GoNorth=window.GoNorth||{});