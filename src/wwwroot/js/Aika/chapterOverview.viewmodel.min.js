(function(n){"use strict";(function(t){t.BaseViewModel=function(){this.nodeGraph=new ko.observable;this.nodePaper=new ko.observable;this.showConfirmNodeDeleteDialog=new ko.observable(!1);this.deleteLoading=new ko.observable(!1);this.deleteErrorOccured=new ko.observable(!1);this.deleteErrorAdditionalInformation=new ko.observable("");this.deleteNodeTarget=null;this.deleteDeferred=null;this.errorOccured=new ko.observable(!1)};t.BaseViewModel.prototype={addNewNode:function(n,t,i){if(this.nodeGraph()&&this.nodePaper()){var r=this.calcNodeInitOptionsPosition(t,i);this.addNodeByType(n.data("nodetype"),r)}},calcNodeInitOptionsPosition:function(n,t){var i=this.nodePaper().scale(),r=this.nodePaper().translate();return{position:{x:(n-r.tx)/i.sx,y:(t-r.ty)/i.sy}}},addNodeByType:function(t,i){var r=n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().createNewNode(t,i);if(r==null){this.errorOccured(!0);return}this.nodeGraph().addCells(r);this.setupNewNode(r)},setupNewNode:function(n){n.attr(".inPorts circle/magnet","passive");var t=this;n.onDelete=function(n){return t.onDelete(n)}},reloadFieldsForNodes:function(t,i){var e,f,r,u;if(n.DefaultNodeShapes.Shapes.resetSharedObjectLoading(t,i),this.nodeGraph())for(e=this.nodePaper(),f=this.nodeGraph().getElements(),r=0;r<f.length;++r)u=e.findViewByModel(f[r]),u&&u.reloadSharedLoadedData&&u.reloadSharedLoadedData(t,i)},onDelete:function(n){return this.deleteLoading(!1),this.deleteErrorOccured(!1),this.deleteErrorAdditionalInformation(""),this.showConfirmNodeDeleteDialog(!0),this.deleteNodeTarget=n,this.deleteDeferred=new jQuery.Deferred,this.deleteDeferred.promise()},deleteNode:function(){var t,n;this.deleteNodeTarget&&this.deleteNodeTarget.validateDelete?(t=this.deleteNodeTarget.validateDelete(),t?(n=this,this.deleteLoading(!0),this.deleteErrorOccured(!1),this.deleteErrorAdditionalInformation(""),t.done(function(){n.deleteLoading(!1);n.resolveDeleteDeferred()}).fail(function(t){n.deleteLoading(!1);n.deleteErrorOccured(!0);n.deleteErrorAdditionalInformation(t)})):this.resolveDeleteDeferred()):this.resolveDeleteDeferred()},resolveDeleteDeferred:function(){this.deleteDeferred&&(this.deleteDeferred.resolve(),this.deleteDeferred=null);this.closeConfirmNodeDeleteDialog()},closeConfirmNodeDeleteDialog:function(){this.deleteDeferred&&(this.deleteDeferred.reject(),this.deleteDeferred=null);this.showConfirmNodeDeleteDialog(!1);this.deleteLoading(!1);this.deleteErrorOccured(!1);this.deleteErrorAdditionalInformation("");this.deleteNodeTarget=null},setGraphToReadonly:function(){jQuery(".gn-nodeGraphContainer").find("input,textarea,select").prop("disabled",!0);jQuery(".gn-nodeGraphContainer").find(".joint-cell").css("pointer-events","none");jQuery(".gn-nodeGraphContainer").find(".gn-nodeDeleteOnReadonly").remove();jQuery(".gn-nodeGraphContainer").find(".gn-nodeNonClickableOnReadonly").css("pointer-events","none")}}})(n.DefaultNodeShapes=n.DefaultNodeShapes||{})})(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(n){n.setDetailViewIds=function(n,t){var f,r,u,i;if(t)for(f=n.getElements(),r=0;r<f.length;++r)if(u=f[r],!u.get("detailViewId"))for(i=0;i<t.length;++i)if(u.id==t[i].id){u.set("detailViewId",t[i].detailViewId);break}}})(n.Shared=n.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(t){function r(n,i){var r=new jQuery.Deferred;return n.showLoading(),n.hideError(),jQuery.ajax({url:"/api/AikaApi/GetChapterDetail?id="+i,type:"GET"}).done(function(i){n.hideLoading();t.addFinishNodesAsOutports(n,i.finish);r.resolve(i)}).fail(function(){n.hideLoading();n.showError();r.reject()}),r.promise()}t.finishNodeOutportNodeWidth=250;t.finishNodeOutportNodeMinHeight=150;var i=3,u=30;t.addFinishNodesAsOutports=function(n,r){var e,v,l,s,h,c,f,o,a,y,p;for(r||(r=[]),e={},v=n.model.graph.getLinks(),l=0;l<v.length;++l)s=v[l],s.get("source")&&s.get("source").id==n.model.id&&(e[s.get("source").port]=s);for(h=[],c={},f=0;f<r.length;++f)o="finish"+r[f].id,h.push(o),c[o]=r[f].color,a="fill: "+r[f].color,n.model.attr(".outPorts>.port"+f+" circle",{title:r[f].name,style:a}),n.model.attr(".outPorts>.port"+f+" .port-label",{title:r[f].name,"class":"gn-aikaChapterFinishPort",style:a,dx:13}),e[o]&&(e[o].attr(".connection",{style:"stroke: "+r[f].color}),e[o].attr(".marker-target",{style:a}),delete e[o]);n.model.set("outPorts",h);y=t.finishNodeOutportNodeMinHeight;h.length>i&&(y=t.finishNodeOutportNodeMinHeight+(h.length-i)*u);n.model.set("size",{width:t.finishNodeOutportNodeWidth,height:y});jQuery(".gn-aikaChapterFinishPort").each(function(){jQuery(this).find("tspan").text(jQuery(this).attr("title"))});for(p in e)n.model.graph.removeCells([e[p]]);n.model.graph.on("add",function(t){if(t.isLink()&&t.get("source")){var i=t.get("source");i.id==n.model.id&&c[i.port]&&(t.attr(".connection",{style:"stroke: "+c[i.port]}),t.attr(".marker-target",{style:"fill: "+c[i.port]}))}})};t.initDetailView=function(t,i){if(!(t.$box.find(".gn-aikaChapterDetailButton").length>0))return t.$box.append("<button class='gn-aikaChapterDetailButton'>"+n.Localization.Chapter.OpenDetailView+"<\/button>"),t.$box.find(".gn-aikaChapterDetailButton").click(function(){var n=window.open("/Aika/Detail?id="+i);n.refreshChapterNode=function(){r(t,i)}}),r(t,i)};t.validateChapterDetailDelete=function(n){if(!n)return null;var t=new jQuery.Deferred;return jQuery.ajax({url:"/api/AikaApi/ValidateChapterDetailDelete?id="+n,type:"GET"}).done(function(n){n.canBeDeleted?t.resolve():t.reject(n.errorMessage)}).fail(function(){t.reject("")}),t.promise()}})(n.Shared=n.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){function e(){return joint.shapes.devs.Model.extend({defaults:joint.util.deepSupplement({type:r,icon:"glyphicon-king",size:{width:t.Shared.finishNodeOutportNodeWidth,height:t.Shared.finishNodeOutportNodeMinHeight},inPorts:["input"],outPorts:[],attrs:{".inPorts circle":{magnet:"passive","port-type":"input"},".outPorts circle":{magnet:"true"}},detailViewId:"",chapterName:"",chapterNumber:1},joint.shapes.default.Base.prototype.defaults)})}function o(){return joint.shapes.default.BaseView.extend({template:['<div class="node">','<span class="label"><i class="nodeIcon glyphicon"><\/i><span class="labelText"><\/span><\/span>','<span class="gn-nodeLoading" style="display: none"><i class="glyphicon glyphicon-refresh spinning"><\/i><\/span>','<span class="gn-nodeError text-danger" style="display: none" title="'+n.DefaultNodeShapes.Localization.ErrorOccured+'"><i class="glyphicon glyphicon-warning-sign"><\/i><\/span>','<button class="delete gn-nodeDeleteOnReadonly cornerButton" title="'+n.DefaultNodeShapes.Localization.DeleteNode+'">x<\/button>','<input type="text" class="gn-aikaChapterName" placeholder="'+t.Localization.Chapter.ChapterName+'"/>','<input type="text" class="gn-aikaChapterNumber" placeholder="'+t.Localization.Chapter.ChapterNumber+'"/>',"<\/div>",].join(""),initialize:function(){var r,u,i;joint.shapes.default.BaseView.prototype.initialize.apply(this,arguments);r=this;u=this.$box.find(".gn-aikaChapterName");u.on("change",function(){r.model.set("chapterName",u.val())});u.val(this.model.get("chapterName"));i=this.$box.find(".gn-aikaChapterNumber");i.on("change",function(){var n=parseInt(i.val());isNaN(n)&&(n=1,i.val(n));r.model.set("chapterNumber",n)});i.on("keydown",function(t){n.Util.validateNumberKeyPress(i,t)});i.val(this.model.get("chapterNumber"));this.model.on("change:detailViewId",function(){t.Shared.initDetailView(r,r.model.get("detailViewId"))},this);this.model.get("detailViewId")&&t.Shared.initDetailView(this,this.model.get("detailViewId"))},validateDelete:function(){return t.Shared.validateChapterDetailDelete(this.model.get("detailViewId"))},showLoading:function(){this.$box.find(".gn-nodeLoading").show()},hideLoading:function(){this.$box.find(".gn-nodeLoading").hide()},showError:function(){this.$box.find(".gn-nodeError").show()},hideError:function(){this.$box.find(".gn-nodeError").hide()}})}var r="aika.Chapter",f="chapter",u;joint.shapes.aika=joint.shapes.aika||{};joint.shapes.aika.Chapter=e();joint.shapes.aika.ChapterView=o();i.ChapterSerializer=function(){n.DefaultNodeShapes.Serialize.BaseNodeSerializer.apply(this,[joint.shapes.aika.Chapter,r,f])};i.ChapterSerializer.prototype=jQuery.extend({},n.DefaultNodeShapes.Serialize.BaseNodeSerializer.prototype);i.ChapterSerializer.prototype.serialize=function(n){return{id:n.id,x:n.position.x,y:n.position.y,detailViewId:n.detailViewId,name:n.chapterName,chapterNumber:n.chapterNumber}};i.ChapterSerializer.prototype.deserialize=function(n){var t={id:n.id,position:{x:n.x,y:n.y},detailViewId:n.detailViewId,chapterName:n.name,chapterNumber:n.chapterNumber},n=new this.classType(t);return n};u=new i.ChapterSerializer;n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().addNodeSerializer(u)})(t.ChapterOverview=t.ChapterOverview||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){i.ViewModel=function(){n.DefaultNodeShapes.BaseViewModel.apply(this);this.id=new ko.observable("");this.isLoading=new ko.observable(!1);this.isReadonly=new ko.observable(!1);this.lockedByUser=new ko.observable("");this.additionalErrorDetails=new ko.observable("");this.load()};i.ViewModel.prototype=jQuery.extend({},n.DefaultNodeShapes.BaseViewModel.prototype);i.ViewModel.prototype.save=function(){var r,i;this.nodeGraph()&&(r=n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().serializeGraph(this.nodeGraph()),this.isLoading(!0),this.errorOccured(!1),i=this,jQuery.ajax({url:"/api/AikaApi/SaveChapterOverview",headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(r),type:"POST",contentType:"application/json"}).done(function(n){t.Shared.setDetailViewIds(i.nodeGraph(),n.chapter);i.id()||(i.id(n.id),i.acquireLock());i.isLoading(!1)}).fail(function(n){i.isLoading(!1);i.errorOccured(!0);n.status==400&&n.responseText&&i.additionalErrorDetails(n.responseText)}))};i.ViewModel.prototype.load=function(){this.isLoading(!0);this.errorOccured(!1);var t=this;jQuery.ajax({url:"/api/AikaApi/GetChapterOverview",type:"GET"}).done(function(i){t.isLoading(!1);i&&(t.id(i.id),t.acquireLock(),n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().deserializeGraph(t.nodeGraph(),i,function(n){t.setupNewNode(n)}),t.isReadonly()&&t.setGraphToReadonly())}).fail(function(){t.isLoading(!1);t.errorOccured(!0)})};i.ViewModel.prototype.acquireLock=function(){this.lockedByUser("");this.isReadonly(!1);var t=this;n.LockService.acquireLock("ChapterOverview",this.id()).done(function(n,i){n&&(t.isReadonly(!0),t.lockedByUser(i),t.setGraphToReadonly())}).fail(function(){t.errorOccured(!0)})};i.ViewModel.prototype.openQuestList=function(){window.location="/Aika/QuestList"}})(t.ChapterOverview=t.ChapterOverview||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{});