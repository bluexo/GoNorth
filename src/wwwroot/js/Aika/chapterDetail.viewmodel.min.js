(function(n){"use strict";(function(n){var t=15;n.ViewModel=function(){this.showDialog=new ko.observable(!1);this.dialogTitle=new ko.observable("");this.showNewButtonInDialog=new ko.observable(!1);this.dialogSearchCallback=null;this.dialogCreateNewCallback=null;this.dialogSearchPattern=new ko.observable("");this.dialogIsLoading=new ko.observable(!1);this.dialogEntries=new ko.observableArray;this.dialogHasMore=new ko.observable(!1);this.dialogCurrentPage=new ko.observable(0);this.errorOccured=new ko.observable(!1);this.idObservable=null;this.choosingDeferred=null};n.ViewModel.prototype={openNpcSearch:function(n,t){return this.openDialog(n,this.searchNpcs,t,null)},openItemSearch:function(n,t){return this.openDialog(n,this.searchItems,t,null)},openSkillSearch:function(n,t){return this.openDialog(n,this.searchSkills,t,null)},openKirjaPageSearch:function(n,t,i){return this.openDialog(n,this.searchPages,t,i)},openQuestSearch:function(n,t){return this.openDialog(n,this.searchQuest,t,null)},openChapterDetailSearch:function(n,t,i){return this.openDialog(n,this.searchChapterDetails,t,i)},openDialog:function(n,t,i,r){return this.choosingDeferred&&(this.choosingDeferred.reject(),this.choosingDeferred=null),this.showDialog(!0),this.dialogTitle(n),this.dialogCreateNewCallback=typeof i=="function"?i:null,this.showNewButtonInDialog(this.dialogCreateNewCallback?!0:!1),this.dialogSearchCallback=t,this.dialogSearchPattern(""),this.dialogIsLoading(!1),this.dialogEntries([]),this.dialogHasMore(!1),this.dialogCurrentPage(0),this.idObservable=r,this.choosingDeferred=new jQuery.Deferred,this.choosingDeferred.promise()},selectObject:function(n){this.choosingDeferred&&(this.choosingDeferred.resolve(n),this.choosingDeferred=null);this.closeDialog()},cancelDialog:function(){this.choosingDeferred&&(this.choosingDeferred.reject(),this.choosingDeferred=null);this.closeDialog()},closeDialog:function(){this.showDialog(!1)},startNewDialogSearch:function(){this.dialogCurrentPage(0);this.dialogHasMore(!1);this.runDialogSearch()},prevDialogPage:function(){this.dialogCurrentPage(this.dialogCurrentPage()-1);this.runDialogSearch()},nextDialogPage:function(){this.dialogCurrentPage(this.dialogCurrentPage()+1);this.runDialogSearch()},runDialogSearch:function(){this.dialogIsLoading(!0);this.errorOccured(!1);var n=this;this.dialogSearchCallback(this.dialogSearchPattern()).done(function(t){n.dialogHasMore(t.hasMore);n.dialogEntries(t.entries);n.dialogIsLoading(!1)}).fail(function(){n.errorOccured(!0);n.dialogIsLoading(!1)})},createDialogObject:function(n,t,i){return{id:n,name:t,openLink:i}},searchPages:function(n){var i=new jQuery.Deferred,r="/api/KirjaApi/SearchPages?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,u;return this.idObservable&&(r+="&excludeId="+this.idObservable()),u=this,jQuery.ajax({url:r,type:"GET"}).done(function(n){for(var r={hasMore:n.hasMore,entries:[]},t=0;t<n.pages.length;++t)r.entries.push(u.createDialogObject(n.pages[t].id,n.pages[t].name,"/Kirja?id="+n.pages[t].id));i.resolve(r)}).fail(function(){i.reject()}),i.promise()},openCreatePage:function(){this.dialogCreateNewCallback()},searchNpcs:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/KortistoApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Kortisto/Npc?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchItems:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/StyrApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Styr/Item?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchSkills:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/EvneApi/SearchFlexFieldObjects?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.flexFieldObjects.length;++t)u.entries.push(r.createDialogObject(n.flexFieldObjects[t].id,n.flexFieldObjects[t].name,"/Evne/Skill?id="+n.flexFieldObjects[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchQuest:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/AikaApi/GetQuests?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.quests.length;++t)u.entries.push(r.createDialogObject(n.quests[t].id,n.quests[t].name,"/Aika/Quest?id="+n.quests[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()},searchChapterDetails:function(n){var i=new jQuery.Deferred,r=this;return jQuery.ajax({url:"/api/AikaApi/GetChapterDetails?searchPattern="+encodeURIComponent(n)+"&start="+this.dialogCurrentPage()*t+"&pageSize="+t,type:"GET"}).done(function(n){for(var u={hasMore:n.hasMore,entries:[]},t=0;t<n.details.length;++t)r.idObservable&&r.idObservable()==n.details[t].id||u.entries.push(r.createDialogObject(n.details[t].id,n.details[t].name,"/Aika/Detail?id="+n.details[t].id));i.resolve(u)}).fail(function(){i.reject()}),i.promise()}}})(n.ChooseObjectDialog=n.ChooseObjectDialog||{})})(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){t.BaseViewModel=function(){this.nodeGraph=new ko.observable;this.nodePaper=new ko.observable;this.showConfirmNodeDeleteDialog=new ko.observable(!1);this.deleteLoading=new ko.observable(!1);this.deleteErrorOccured=new ko.observable(!1);this.deleteErrorAdditionalInformation=new ko.observable("");this.deleteNodeTarget=null;this.deleteDeferred=null;this.errorOccured=new ko.observable(!1)};t.BaseViewModel.prototype={addNewNode:function(n,t,i){if(this.nodeGraph()&&this.nodePaper()){var r=this.calcNodeInitOptionsPosition(t,i);this.addNodeByType(n.data("nodetype"),r)}},calcNodeInitOptionsPosition:function(n,t){var i=this.nodePaper().scale(),r=this.nodePaper().translate();return{position:{x:(n-r.tx)/i.sx,y:(t-r.ty)/i.sy}}},addNodeByType:function(t,i){var r=n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().createNewNode(t,i);if(r==null){this.errorOccured(!0);return}this.nodeGraph().addCells(r);this.setupNewNode(r)},setupNewNode:function(n){n.attr(".inPorts circle/magnet","passive");var t=this;n.onDelete=function(n){return t.onDelete(n)}},reloadFieldsForNodes:function(t,i){var e,f,r,u;if(n.DefaultNodeShapes.Shapes.resetSharedObjectLoading(t,i),this.nodeGraph())for(e=this.nodePaper(),f=this.nodeGraph().getElements(),r=0;r<f.length;++r)u=e.findViewByModel(f[r]),u&&u.reloadSharedLoadedData&&u.reloadSharedLoadedData(t,i)},onDelete:function(n){return this.deleteLoading(!1),this.deleteErrorOccured(!1),this.deleteErrorAdditionalInformation(""),this.showConfirmNodeDeleteDialog(!0),this.deleteNodeTarget=n,this.deleteDeferred=new jQuery.Deferred,this.deleteDeferred.promise()},deleteNode:function(){var t,n;this.deleteNodeTarget&&this.deleteNodeTarget.validateDelete?(t=this.deleteNodeTarget.validateDelete(),t?(n=this,this.deleteLoading(!0),this.deleteErrorOccured(!1),this.deleteErrorAdditionalInformation(""),t.done(function(){n.deleteLoading(!1);n.resolveDeleteDeferred()}).fail(function(t){n.deleteLoading(!1);n.deleteErrorOccured(!0);n.deleteErrorAdditionalInformation(t)})):this.resolveDeleteDeferred()):this.resolveDeleteDeferred()},resolveDeleteDeferred:function(){this.deleteDeferred&&(this.deleteDeferred.resolve(),this.deleteDeferred=null);this.closeConfirmNodeDeleteDialog()},closeConfirmNodeDeleteDialog:function(){this.deleteDeferred&&(this.deleteDeferred.reject(),this.deleteDeferred=null);this.showConfirmNodeDeleteDialog(!1);this.deleteLoading(!1);this.deleteErrorOccured(!1);this.deleteErrorAdditionalInformation("");this.deleteNodeTarget=null},setGraphToReadonly:function(){jQuery(".gn-nodeGraphContainer").find("input,textarea,select").prop("disabled",!0);jQuery(".gn-nodeGraphContainer").find(".joint-cell").css("pointer-events","none");jQuery(".gn-nodeGraphContainer").find(".gn-nodeDeleteOnReadonly").remove();jQuery(".gn-nodeGraphContainer").find(".gn-nodeNonClickableOnReadonly").css("pointer-events","none")}}})(n.DefaultNodeShapes=n.DefaultNodeShapes||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(n){n.setDetailViewIds=function(n,t){var f,r,u,i;if(t)for(f=n.getElements(),r=0;r<f.length;++r)if(u=f[r],!u.get("detailViewId"))for(i=0;i<t.length;++i)if(u.id==t[i].id){u.set("detailViewId",t[i].detailViewId);break}}})(n.Shared=n.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(n){(function(t){function r(n,i){var r=new jQuery.Deferred;return n.showLoading(),n.hideError(),jQuery.ajax({url:"/api/AikaApi/GetChapterDetail?id="+i,type:"GET"}).done(function(i){n.hideLoading();t.addFinishNodesAsOutports(n,i.finish);r.resolve(i)}).fail(function(){n.hideLoading();n.showError();r.reject()}),r.promise()}t.finishNodeOutportNodeWidth=250;t.finishNodeOutportNodeMinHeight=150;var i=3,u=30;t.addFinishNodesAsOutports=function(n,r){var e,v,l,s,h,c,f,o,a,y,p;for(r||(r=[]),e={},v=n.model.graph.getLinks(),l=0;l<v.length;++l)s=v[l],s.get("source")&&s.get("source").id==n.model.id&&(e[s.get("source").port]=s);for(h=[],c={},f=0;f<r.length;++f)o="finish"+r[f].id,h.push(o),c[o]=r[f].color,a="fill: "+r[f].color,n.model.attr(".outPorts>.port"+f+" circle",{title:r[f].name,style:a}),n.model.attr(".outPorts>.port"+f+" .port-label",{title:r[f].name,"class":"gn-aikaChapterFinishPort",style:a,dx:13}),e[o]&&(e[o].attr(".connection",{style:"stroke: "+r[f].color}),e[o].attr(".marker-target",{style:a}),delete e[o]);n.model.set("outPorts",h);y=t.finishNodeOutportNodeMinHeight;h.length>i&&(y=t.finishNodeOutportNodeMinHeight+(h.length-i)*u);n.model.set("size",{width:t.finishNodeOutportNodeWidth,height:y});jQuery(".gn-aikaChapterFinishPort").each(function(){jQuery(this).find("tspan").text(jQuery(this).attr("title"))});for(p in e)n.model.graph.removeCells([e[p]]);n.model.graph.on("add",function(t){if(t.isLink()&&t.get("source")){var i=t.get("source");i.id==n.model.id&&c[i.port]&&(t.attr(".connection",{style:"stroke: "+c[i.port]}),t.attr(".marker-target",{style:"fill: "+c[i.port]}))}})};t.initDetailView=function(t,i){if(!(t.$box.find(".gn-aikaChapterDetailButton").length>0))return t.$box.append("<button class='gn-aikaChapterDetailButton'>"+n.Localization.Chapter.OpenDetailView+"<\/button>"),t.$box.find(".gn-aikaChapterDetailButton").click(function(){var n=window.open("/Aika/Detail?id="+i);n.refreshChapterNode=function(){r(t,i)}}),r(t,i)};t.validateChapterDetailDelete=function(n){if(!n)return null;var t=new jQuery.Deferred;return jQuery.ajax({url:"/api/AikaApi/ValidateChapterDetailDelete?id="+n,type:"GET"}).done(function(n){n.canBeDeleted?t.resolve():t.reject(n.errorMessage)}).fail(function(){t.reject("")}),t.promise()}})(n.Shared=n.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){function o(){return joint.shapes.devs.Model.extend({defaults:joint.util.deepSupplement({type:u,icon:"glyphicon-flag",size:{width:250,height:150},inPorts:["input"],outPorts:[],attrs:{".inPorts circle":{magnet:"passive","port-type":"input"}},detailViewId:"",finishName:"",finishColor:r[0].color},joint.shapes.default.Base.prototype.defaults)})}function s(){return joint.shapes.default.BaseView.extend({template:['<div class="node">','<span class="label"><i class="nodeIcon glyphicon"><\/i><span class="labelText"><\/span><\/span>','<button class="delete gn-nodeDeleteOnReadonly cornerButton" title="'+n.DefaultNodeShapes.Localization.DeleteNode+'">x<\/button>','<input type="text" class="gn-aikaFinishName" placeholder="'+t.Localization.Finish.FinishName+'"/>','<select class="gn-aikaFinishColor"/>',"<\/div>",].join(""),initialize:function(){var f,u,n,i;joint.shapes.default.BaseView.prototype.initialize.apply(this,arguments);f=this;u=this.$box.find(".gn-aikaFinishName");u.on("change",function(){f.model.set("finishName",u.val())});for(u.val(this.model.get("finishName")),n=this.$box.find(".gn-aikaFinishColor"),i=0;i<r.length;++i)n.append(jQuery("<option>",{value:r[i].color,text:t.Localization.Finish.Colors[r[i].name]}));n.on("change",function(){f.model.set("finishColor",n.val())});n.find("option[value='"+this.model.get("finishColor")+"']").prop("selected",!0)}})}var u="aika.Finish",e="finish",r=[{name:"White",color:"#FFFFFF"},{name:"Red",color:"#CC0000"},{name:"Green",color:"#008800"},{name:"Blue",color:"#0000CC"},{name:"Yellow",color:"#FDFF00"},{name:"Purple",color:"#66008e"}],f;joint.shapes.aika=joint.shapes.aika||{};joint.shapes.aika.Finish=o();joint.shapes.aika.FinishView=s();i.FinishSerializer=function(){n.DefaultNodeShapes.Serialize.BaseNodeSerializer.apply(this,[joint.shapes.aika.Finish,u,e])};i.FinishSerializer.prototype=jQuery.extend({},n.DefaultNodeShapes.Serialize.BaseNodeSerializer.prototype);i.FinishSerializer.prototype.serialize=function(n){return{id:n.id,x:n.position.x,y:n.position.y,detailViewId:n.detailViewId,name:n.finishName,color:n.finishColor}};i.FinishSerializer.prototype.deserialize=function(n){var t={id:n.id,position:{x:n.x,y:n.y},detailViewId:n.detailViewId,finishName:n.name,finishColor:n.color},n=new this.classType(t);return n};f=new i.FinishSerializer;n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().addNodeSerializer(f)})(t.Shared=t.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(t){function u(){return joint.shapes.devs.Model.extend({defaults:joint.util.deepSupplement({type:t.startType,icon:"glyphicon-play",size:{width:100,height:50},inPorts:[],outPorts:["output"],attrs:{".outPorts circle":{magnet:"true"}}},joint.shapes.default.Base.prototype.defaults)})}function f(){return joint.shapes.default.BaseView.extend({template:['<div class="node">','<span class="label"><i class="nodeIcon glyphicon"><\/i><span class="labelText"><\/span><\/span>',"<\/div>",].join("")})}var i,r;t.startType="aika.Start";i="start";joint.shapes.aika=joint.shapes.aika||{};joint.shapes.aika.Start=u();joint.shapes.aika.StartView=f();t.StartSerializer=function(){n.DefaultNodeShapes.Serialize.BaseNodeSerializer.apply(this,[joint.shapes.aika.Start,t.startType,i])};t.StartSerializer.prototype=jQuery.extend({},n.DefaultNodeShapes.Serialize.BaseNodeSerializer.prototype);t.StartSerializer.prototype.serialize=function(n){return{id:n.id,x:n.position.x,y:n.position.y}};t.StartSerializer.prototype.deserialize=function(n){var t={id:n.id,position:{x:n.x,y:n.y}},n=new this.classType(t);return n};r=new t.StartSerializer;n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().addNodeSerializer(r)})(t.Shared=t.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(t){function f(){return joint.shapes.devs.Model.extend({defaults:joint.util.deepSupplement({type:i,icon:"glyphicon-resize-small",size:{width:175,height:50},inPorts:["input"],outPorts:["output"],attrs:{".inPorts circle":{magnet:"passive","port-type":"input"},".outPorts circle":{magnet:"true"}}},joint.shapes.default.Base.prototype.defaults)})}function e(){return joint.shapes.default.BaseView.extend({template:['<div class="node">','<span class="label"><i class="nodeIcon glyphicon"><\/i><span class="labelText"><\/span><\/span>','<button class="delete gn-nodeDeleteOnReadonly cornerButton" title="'+n.DefaultNodeShapes.Localization.DeleteNode+'">x<\/button>',"<\/div>",].join("")})}var i="aika.AllDone",u="allDone",r;joint.shapes.aika=joint.shapes.aika||{};joint.shapes.aika.AllDone=f();joint.shapes.aika.AllDoneView=e();t.AllDoneSerializer=function(){n.DefaultNodeShapes.Serialize.BaseNodeSerializer.apply(this,[joint.shapes.aika.AllDone,i,u])};t.AllDoneSerializer.prototype=jQuery.extend({},n.DefaultNodeShapes.Serialize.BaseNodeSerializer.prototype);t.AllDoneSerializer.prototype.serialize=function(n){return{id:n.id,x:n.position.x,y:n.position.y}};t.AllDoneSerializer.prototype.deserialize=function(n){var t={id:n.id,position:{x:n.x,y:n.y}},n=new this.classType(t);return n};r=new t.AllDoneSerializer;n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().addNodeSerializer(r)})(t.Shared=t.Shared||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){function e(){return joint.shapes.devs.Model.extend({defaults:joint.util.deepSupplement({type:r,icon:"glyphicon-king",size:{width:t.Shared.finishNodeOutportNodeWidth,height:t.Shared.finishNodeOutportNodeMinHeight},inPorts:["input"],outPorts:[],attrs:{".inPorts circle":{magnet:"passive","port-type":"input"},".outPorts circle":{magnet:"true"}},questId:""},joint.shapes.default.Base.prototype.defaults)})}function o(){return joint.shapes.default.BaseView.extend({template:['<div class="node">','<span class="label"><i class="nodeIcon glyphicon"><\/i><span class="labelText"><\/span><\/span>','<span class="gn-nodeLoading" style="display: none"><i class="glyphicon glyphicon-refresh spinning"><\/i><\/span>','<span class="gn-nodeError text-danger" style="display: none" title="'+n.DefaultNodeShapes.Localization.ErrorOccured+'"><i class="glyphicon glyphicon-warning-sign"><\/i><\/span>','<button class="delete gn-nodeDeleteOnReadonly cornerButton" title="'+n.DefaultNodeShapes.Localization.DeleteNode+'">x<\/button>','<a class="gn-clickable gn-aikaNodeQuestName"><\/div>',"<\/div>",].join(""),initialize:function(){if(joint.shapes.default.BaseView.prototype.initialize.apply(this,arguments),this.model.get("questId")){this.loadQuestData();var n=this;this.$box.find(".gn-aikaNodeQuestName").click(function(){var t=window.open("/Aika/Quest?id="+n.model.get("questId"));t.onQuestSaved=function(){n.loadQuestData()}})}else this.showError()},loadQuestData:function(){var n=this;this.showLoading();this.hideError();jQuery.ajax({url:"/api/AikaApi/GetQuest?id="+n.model.get("questId"),type:"GET"}).done(function(i){if(n.hideLoading(),!i){n.showError();return}n.$box.find(".gn-aikaNodeQuestName").text(i.name);i.isMainQuest&&n.$box.find(".gn-aikaNodeQuestName").prepend("<i class='glyphicon glyphicon-star gn-aikaNodeQuestMain' title='"+t.Localization.QuestNode.IsMainQuestTooltip+"'><\/i>");t.Shared.addFinishNodesAsOutports(n,i.finish)}).fail(function(){n.hideLoading();n.showError()})},showLoading:function(){this.$box.find(".gn-nodeLoading").show()},hideLoading:function(){this.$box.find(".gn-nodeLoading").hide()},showError:function(){this.$box.find(".gn-nodeError").show()},hideError:function(){this.$box.find(".gn-nodeError").hide()}})}var r="aika.Quest",f="quest",u;joint.shapes.aika=joint.shapes.aika||{};joint.shapes.aika.Quest=e();joint.shapes.aika.QuestView=o();i.QuestSerializer=function(){n.DefaultNodeShapes.Serialize.BaseNodeSerializer.apply(this,[joint.shapes.aika.Quest,r,f])};i.QuestSerializer.prototype=jQuery.extend({},n.DefaultNodeShapes.Serialize.BaseNodeSerializer.prototype);i.QuestSerializer.prototype.serialize=function(n){return{id:n.id,x:n.position.x,y:n.position.y,questId:n.questId}};i.QuestSerializer.prototype.deserialize=function(n){var t={id:n.id,position:{x:n.x,y:n.y},questId:n.questId},n=new this.classType(t);return n};u=new i.QuestSerializer;n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().addNodeSerializer(u)})(t.ChapterDetail=t.ChapterDetail||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){function e(){return joint.shapes.devs.Model.extend({defaults:joint.util.deepSupplement({type:r,icon:"glyphicon-king",size:{width:t.Shared.finishNodeOutportNodeWidth,height:t.Shared.finishNodeOutportNodeMinHeight},inPorts:["input"],outPorts:[],attrs:{".inPorts circle":{magnet:"passive","port-type":"input"},".outPorts circle":{magnet:"true"}},detailViewId:"",detailName:""},joint.shapes.default.Base.prototype.defaults)})}function o(){return joint.shapes.default.BaseView.extend({template:['<div class="node">','<span class="label"><i class="nodeIcon glyphicon"><\/i><span class="labelText"><\/span><\/span>','<span class="gn-nodeLoading" style="display: none"><i class="glyphicon glyphicon-refresh spinning"><\/i><\/span>','<span class="gn-nodeError text-danger" style="display: none" title="'+n.DefaultNodeShapes.Localization.ErrorOccured+'"><i class="glyphicon glyphicon-warning-sign"><\/i><\/span>','<button class="delete gn-nodeDeleteOnReadonly cornerButton" title="'+n.DefaultNodeShapes.Localization.DeleteNode+'">x<\/button>','<input type="text" class="gn-aikaChapterDetailName" placeholder="'+t.Localization.ChapterDetail.DetailName+'"/>',"<\/div>",].join(""),initialize:function(){joint.shapes.default.BaseView.prototype.initialize.apply(this,arguments);var t=this,n=this.$box.find(".gn-aikaChapterDetailName");n.on("change",function(){t.model.set("detailName",n.val())});n.val(this.model.get("detailName"));this.model.on("change:detailViewId",this.initChapterDetail,this);this.model.get("detailViewId")&&this.initChapterDetail()},initChapterDetail:function(){var n=this;t.Shared.initDetailView(this,this.model.get("detailViewId")).then(function(t){n.model.set("detailName",t.name);n.$box.find(".gn-aikaChapterDetailName").val(t.name)})},validateDelete:function(){return t.Shared.validateChapterDetailDelete(this.model.get("detailViewId"))},showLoading:function(){this.$box.find(".gn-nodeLoading").show()},hideLoading:function(){this.$box.find(".gn-nodeLoading").hide()},showError:function(){this.$box.find(".gn-nodeError").show()},hideError:function(){this.$box.find(".gn-nodeError").hide()}})}var r="aika.ChapterDetail",f="detail",u;joint.shapes.aika=joint.shapes.aika||{};joint.shapes.aika.ChapterDetail=e();joint.shapes.aika.ChapterDetailView=o();i.ChapterDetailSerializer=function(){n.DefaultNodeShapes.Serialize.BaseNodeSerializer.apply(this,[joint.shapes.aika.ChapterDetail,r,f])};i.ChapterDetailSerializer.prototype=jQuery.extend({},n.DefaultNodeShapes.Serialize.BaseNodeSerializer.prototype);i.ChapterDetailSerializer.prototype.serialize=function(n){return{id:n.id,x:n.position.x,y:n.position.y,detailViewId:n.detailViewId,name:n.detailName}};i.ChapterDetailSerializer.prototype.deserialize=function(n){var t={id:n.id,position:{x:n.x,y:n.y},detailViewId:n.detailViewId,detailName:n.name},n=new this.classType(t);return n};u=new i.ChapterDetailSerializer;n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().addNodeSerializer(u)})(t.ChapterDetail=t.ChapterDetail||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{}),function(n){"use strict";(function(t){(function(i){i.ViewModel=function(){n.DefaultNodeShapes.BaseViewModel.apply(this);this.id=new ko.observable("");var t=n.Util.getParameterFromUrl("id");t&&this.id(t);this.objectDialog=new n.ChooseObjectDialog.ViewModel;this.name=new ko.observable("");this.isLoading=new ko.observable(!1);this.isReadonly=new ko.observable(!1);this.lockedByUser=new ko.observable("");this.showWaitNewObjectDialog=new ko.observable(!1);this.additionalErrorDetails=new ko.observable("");this.load();this.acquireLock()};i.ViewModel.prototype=jQuery.extend({},n.DefaultNodeShapes.BaseViewModel.prototype);i.ViewModel.prototype.addNewNode=function(t,i,r){if(jQuery(t).hasClass("gn-nodeNewQuest")){this.createNewQuestNode(i,r);return}if(jQuery(t).hasClass("gn-nodeExistingQuest")){this.createExistingQuestNode(i,r);return}if(jQuery(t).hasClass("gn-nodeExistingDetailView")){this.createExistingChapterDetailNode(i,r);return}n.DefaultNodeShapes.BaseViewModel.prototype.addNewNode.apply(this,arguments)};i.ViewModel.prototype.createNewQuestNode=function(n,t){var r=this,i;this.showWaitNewObjectDialog(!0);i=window.open("/Aika/Quest");i.onbeforeunload=function(){r.showWaitNewObjectDialog(!1)};i.onQuestSaved=function(u){i.onQuestSaved=null;r.showWaitNewObjectDialog(!1);r.addNewQuestNode(u,n,t)}};i.ViewModel.prototype.createExistingQuestNode=function(n,i){var r=this;this.objectDialog.openQuestSearch(t.Localization.ViewModel.ChooseQuest).then(function(t){r.addNewQuestNode(t.id,n,i)})};i.ViewModel.prototype.addNewQuestNode=function(n,t,i){var r=this.calcNodeInitOptionsPosition(t,i);r.questId=n;this.addNodeByType("aika.Quest",r)};i.ViewModel.prototype.createExistingChapterDetailNode=function(n,i){var r=this;this.objectDialog.openChapterDetailSearch(t.Localization.ViewModel.ChooseChapterDetail,null,this.id).then(function(t){var u=r.calcNodeInitOptionsPosition(n,i);u.detailViewId=t.id;r.addNodeByType("aika.ChapterDetail",u)})};i.ViewModel.prototype.save=function(){var r,i;this.nodeGraph()&&(r=n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().serializeGraph(this.nodeGraph()),this.isLoading(!0),this.errorOccured(!1),i=this,jQuery.ajax({url:"/api/AikaApi/UpdateChapterDetail?id="+this.id(),headers:n.Util.generateAntiForgeryHeader(),data:JSON.stringify(r),type:"POST",contentType:"application/json"}).done(function(n){t.Shared.setDetailViewIds(i.nodeGraph(),n.detail);i.id()||(i.id(n.id),i.acquireLock());window.refreshChapterNode&&window.refreshChapterNode();i.isLoading(!1)}).fail(function(n){i.isLoading(!1);i.errorOccured(!0);n.status==400&&n.responseText&&i.additionalErrorDetails(n.responseText)}))};i.ViewModel.prototype.load=function(){this.isLoading(!0);this.errorOccured(!1);var t=this;jQuery.ajax({url:"/api/AikaApi/GetChapterDetail?id="+this.id(),type:"GET"}).done(function(i){t.isLoading(!1);t.name(i.name);n.DefaultNodeShapes.Serialize.getNodeSerializerInstance().deserializeGraph(t.nodeGraph(),i,function(n){t.setupNewNode(n)});t.isReadonly()&&t.setGraphToReadonly()}).fail(function(){t.isLoading(!1);t.errorOccured(!0)})};i.ViewModel.prototype.acquireLock=function(){if(this.id()){this.lockedByUser("");this.isReadonly(!1);var t=this;n.LockService.acquireLock("ChapterDetail",this.id()).done(function(n,i){n&&(t.isReadonly(!0),t.lockedByUser(i),t.setGraphToReadonly())}).fail(function(){t.errorOccured(!0)})}};i.ViewModel.prototype.openQuestList=function(){window.location="/Aika/QuestList"}})(t.ChapterDetail=t.ChapterDetail||{})})(n.Aika=n.Aika||{})}(window.GoNorth=window.GoNorth||{});